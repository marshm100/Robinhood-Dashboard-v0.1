{% extends "base.html" %}
{% block title %}{{ portfolio.name }} - Portfolio Details{% endblock %}
{% block content %}
<div class="mb-8 flex justify-between items-center">
    <div>
        <h2 class="text-3xl font-bold">{{ portfolio.name }}</h2>
        <p class="text-gray-600">Created: {{ portfolio.created_at.strftime('%Y-%m-%d') }} | ID: {{ portfolio.id }}</p>
    </div>
    <div class="space-x-4">
        <a href="/upload?portfolio_id={{ portfolio.id }}" class="px-6 py-3 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition">
            Upload CSV
        </a>
        <a href="/portfolios" class="px-6 py-3 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition">
            Back to Portfolios
        </a>
    </div>
</div>

<!-- Holdings Table -->
<div class="bg-white rounded-lg shadow-lg p-6 mb-8">
    <h3 class="text-xl font-semibold mb-4">Holdings ({{ holdings|length }} positions)</h3>

    {% if holdings %}
    <div class="overflow-x-auto">
        <table class="w-full">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Ticker</th>
                    <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">Shares</th>
                    <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">Cost Basis</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
                {% for holding in holdings %}
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-3 font-medium text-indigo-600">{{ holding.ticker }}</td>
                    <td class="px-4 py-3 text-right">{{ "%.4f"|format(holding.shares) }}</td>
                    <td class="px-4 py-3 text-right">
                        {% if holding.cost_basis %}
                        ${{ "%.2f"|format(holding.cost_basis) }}
                        {% else %}
                        <span class="text-gray-400">-</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="text-center py-12 text-gray-500">
        <p class="text-lg mb-4">No holdings yet.</p>
        <a href="/upload?portfolio_id={{ portfolio.id }}" class="text-indigo-600 hover:underline">Upload a CSV to add holdings</a>
    </div>
    {% endif %}
</div>

<!-- Performance Chart -->
{% if holdings %}
<div class="bg-white rounded-lg shadow-lg p-6 mb-8">
    <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-semibold">Performance vs Benchmark</h3>
        <div class="flex space-x-4">
            <select id="benchmarkSelect" class="px-4 py-2 border border-gray-300 rounded-lg">
                <option value="SPY" selected>SPY (S&P 500)</option>
                <option value="QQQ">QQQ (Nasdaq 100)</option>
                <option value="IWM">IWM (Russell 2000)</option>
                <option value="DIA">DIA (Dow Jones)</option>
            </select>
            <select id="periodSelect" class="px-4 py-2 border border-gray-300 rounded-lg">
                <option value="1mo">1 Month</option>
                <option value="3mo">3 Months</option>
                <option value="6mo">6 Months</option>
                <option value="1y" selected>1 Year</option>
                <option value="2y">2 Years</option>
            </select>
            <button id="refreshChart" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition flex items-center">
                <span id="refreshText">Refresh</span>
                <svg id="refreshSpinner" class="hidden animate-spin ml-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </button>
        </div>
    </div>

    <div id="chartContainer" class="h-96 relative">
        <div id="chartLoading" class="absolute inset-0 flex flex-col items-center justify-center bg-gray-50 rounded-lg">
            <svg class="animate-spin h-10 w-10 text-indigo-600 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="text-gray-600" id="loadingText">Loading price data...</p>
            <p class="text-gray-400 text-sm mt-2" id="loadingSubtext">This may take a moment on first load</p>
        </div>
        <canvas id="performanceChart"></canvas>
    </div>

    <div id="chartError" class="hidden mt-4 p-4 rounded-lg"></div>

    <div id="chartStats" class="mt-6 grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4 hidden">
        <div class="bg-indigo-50 p-4 rounded-lg">
            <p class="text-sm text-gray-600">Portfolio Return</p>
            <p id="portfolioReturn" class="text-2xl font-bold text-indigo-700">-</p>
        </div>
        <div class="bg-gray-50 p-4 rounded-lg">
            <p class="text-sm text-gray-600">Benchmark Return</p>
            <p id="benchmarkReturn" class="text-2xl font-bold text-gray-700">-</p>
        </div>
        <div id="alphaBox" class="bg-green-50 p-4 rounded-lg">
            <p class="text-sm text-gray-600">Alpha</p>
            <p id="alpha" class="text-2xl font-bold text-green-700">-</p>
        </div>
        <div class="bg-blue-50 p-4 rounded-lg">
            <p class="text-sm text-gray-600">Current Value</p>
            <p id="currentValue" class="text-2xl font-bold text-blue-700">-</p>
        </div>
        <div id="costBasisBox" class="bg-yellow-50 p-4 rounded-lg hidden">
            <p class="text-sm text-gray-600">vs Cost Basis</p>
            <p id="costBasisReturn" class="text-2xl font-bold text-yellow-700">-</p>
        </div>
        <div class="bg-purple-50 p-4 rounded-lg">
            <p class="text-sm text-gray-600">Holdings Included</p>
            <p id="holdingsIncluded" class="text-2xl font-bold text-purple-700">-</p>
        </div>
    </div>
</div>
{% endif %}

<script>
{% if holdings %}
const portfolioId = {{ portfolio.id }};
let chart = null;
let isLoading = false;

function setLoading(loading, text = 'Loading price data...', subtext = 'This may take a moment on first load') {
    isLoading = loading;
    const loadingDiv = document.getElementById('chartLoading');
    const loadingTextEl = document.getElementById('loadingText');
    const loadingSubtextEl = document.getElementById('loadingSubtext');
    const refreshBtn = document.getElementById('refreshChart');
    const refreshText = document.getElementById('refreshText');
    const refreshSpinner = document.getElementById('refreshSpinner');

    if (loading) {
        loadingDiv.classList.remove('hidden');
        loadingTextEl.textContent = text;
        loadingSubtextEl.textContent = subtext;
        refreshBtn.disabled = true;
        refreshText.textContent = 'Loading...';
        refreshSpinner.classList.remove('hidden');
    } else {
        loadingDiv.classList.add('hidden');
        refreshBtn.disabled = false;
        refreshText.textContent = 'Refresh';
        refreshSpinner.classList.add('hidden');
    }
}

function showError(message, isWarning = false) {
    const errorDiv = document.getElementById('chartError');
    errorDiv.className = `mt-4 p-4 rounded-lg ${isWarning ? 'bg-yellow-100 text-yellow-700' : 'bg-red-100 text-red-700'}`;
    errorDiv.textContent = message;
    errorDiv.classList.remove('hidden');
}

function hideError() {
    document.getElementById('chartError').classList.add('hidden');
}

function formatCurrency(value) {
    return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
    }).format(value);
}

async function loadChartData() {
    if (isLoading) return;

    const benchmark = document.getElementById('benchmarkSelect').value;
    const period = document.getElementById('periodSelect').value;
    const statsDiv = document.getElementById('chartStats');

    setLoading(true, 'Fetching price data...', `Loading ${period} history for ${benchmark}`);
    hideError();
    statsDiv.classList.add('hidden');

    try {
        const response = await fetch(`/api/analysis/compare/${portfolioId}?benchmark=${benchmark}&period=${period}`);
        const data = await response.json();

        setLoading(false);

        if (data.error) {
            throw new Error(data.error);
        }

        // Update stats
        document.getElementById('portfolioReturn').textContent = `${data.final_portfolio_return}%`;
        document.getElementById('benchmarkReturn').textContent = `${data.final_benchmark_return}%`;

        const alpha = data.alpha !== undefined ? data.alpha : (data.final_portfolio_return - data.final_benchmark_return).toFixed(2);
        const alphaEl = document.getElementById('alpha');
        const alphaBox = document.getElementById('alphaBox');
        alphaEl.textContent = `${alpha > 0 ? '+' : ''}${alpha}%`;
        alphaBox.className = alpha >= 0
            ? 'bg-green-50 p-4 rounded-lg'
            : 'bg-red-50 p-4 rounded-lg';
        alphaEl.className = alpha >= 0
            ? 'text-2xl font-bold text-green-700'
            : 'text-2xl font-bold text-red-700';

        // Current value
        if (data.current_value) {
            document.getElementById('currentValue').textContent = formatCurrency(data.current_value);
        } else {
            document.getElementById('currentValue').textContent = '-';
        }

        // Cost basis return
        const costBasisBox = document.getElementById('costBasisBox');
        if (data.cost_basis_return !== null && data.cost_basis_return !== undefined) {
            document.getElementById('costBasisReturn').textContent = `${data.cost_basis_return > 0 ? '+' : ''}${data.cost_basis_return}%`;
            costBasisBox.classList.remove('hidden');
        } else {
            costBasisBox.classList.add('hidden');
        }

        document.getElementById('holdingsIncluded').textContent = `${data.holdings_included || '-'}/${data.holdings_total || '-'}`;
        statsDiv.classList.remove('hidden');

        // Draw chart
        if (chart) chart.destroy();

        const ctx = document.getElementById('performanceChart').getContext('2d');
        chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.dates,
                datasets: [
                    {
                        label: 'Portfolio',
                        data: data.portfolio_returns,
                        borderColor: '#4f46e5',
                        backgroundColor: 'rgba(79, 70, 229, 0.1)',
                        fill: true,
                        tension: 0.1,
                        pointRadius: 0,
                        pointHoverRadius: 4
                    },
                    {
                        label: data.benchmark,
                        data: data.benchmark_returns,
                        borderColor: '#9ca3af',
                        backgroundColor: 'rgba(156, 163, 175, 0.1)',
                        fill: true,
                        tension: 0.1,
                        pointRadius: 0,
                        pointHoverRadius: 4
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    intersect: false,
                    mode: 'index'
                },
                plugins: {
                    legend: { position: 'top' },
                    tooltip: {
                        callbacks: {
                            label: (ctx) => `${ctx.dataset.label}: ${ctx.parsed.y.toFixed(2)}%`
                        }
                    }
                },
                scales: {
                    x: {
                        ticks: {
                            maxTicksLimit: 12,
                            maxRotation: 0
                        }
                    },
                    y: {
                        ticks: {
                            callback: (value) => value + '%'
                        }
                    }
                }
            }
        });

        // Show missing tickers warning if any
        if (data.missing_tickers && data.missing_tickers.length > 0) {
            showError(`Note: Missing price data for: ${data.missing_tickers.join(', ')}`, true);
        }

    } catch (err) {
        setLoading(false);
        showError(`Error loading chart: ${err.message}`);
        console.error('Chart load error:', err);
    }
}

document.getElementById('refreshChart').addEventListener('click', loadChartData);
document.getElementById('benchmarkSelect').addEventListener('change', loadChartData);
document.getElementById('periodSelect').addEventListener('change', loadChartData);

// Initial load
loadChartData();
{% endif %}
</script>
{% endblock %}
