<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Compare portfolios and create custom investment scenarios">
    <meta name="theme-color" content="#ff00ff">
    <title>Portfolio Comparison - Robinhood Portfolio Analysis</title>

    <!-- External Libraries -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-3.2.0.min.js" charset="utf-8"></script>

    <style>
        /* Robinhood-Inspired Cyberpunk Theme */
        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: #12121e;
            --accent-neon: #00ffff;
            --accent-positive: #00ff88;
            --accent-negative: #ff3366;
            --accent-warning: #ffff00;
            --text-primary: #e0e0e0;
            --text-secondary: #8888aa;
            --border-color: rgba(0, 255, 255, 0.15);
            /* Legacy aliases */
            --cyber-pink: #00ffff;
            --cyber-cyan: #00ffff;
            --cyber-green: #00ff88;
            --cyber-red: #ff3366;
            --cyber-yellow: #ffff00;
        }

        * {
            box-sizing: border-box;
        }

        body {
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: 'JetBrains Mono', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            line-height: 1.6;
            letter-spacing: 0.05em;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                linear-gradient(rgba(0, 255, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
            pointer-events: none;
            z-index: -1;
        }

        .cyberpunk-card {
            background: rgba(18, 18, 30, 0.6);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            backdrop-filter: blur(12px);
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
            padding: 1.5rem;
        }

        .cyberpunk-card:hover {
            border-color: var(--accent-neon);
            box-shadow: 0 0 12px rgba(0, 255, 255, 0.15);
        }

        .scanlines::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(
                transparent 50%,
                rgba(255, 255, 255, 0.015) 50%
            );
            background-size: 100% 4px;
            pointer-events: none;
            opacity: 0.6;
        }

        .cyberpunk-button {
            background: var(--accent-neon);
            border: none;
            color: #000;
            font-weight: 600;
            letter-spacing: 0.05em;
            padding: 0.875rem 1.75rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: 48px;
        }

        .cyberpunk-button:hover {
            box-shadow: 0 0 16px rgba(0, 255, 255, 0.4);
            transform: scale(1.02);
        }

        .cyberpunk-button-secondary {
            background: transparent;
            border: 1px solid var(--accent-neon);
            color: var(--accent-neon);
        }

        .cyberpunk-button-secondary:hover {
            background: rgba(0, 255, 255, 0.1);
            box-shadow: 0 0 12px rgba(0, 255, 255, 0.2);
        }

        .glow-text {
            text-shadow: 0 0 8px var(--accent-neon);
        }

        .glow-text-positive {
            text-shadow: 0 0 8px var(--accent-positive);
        }

        .metric-positive { color: var(--cyber-green); text-shadow: 0 0 10px var(--cyber-green); }
        .metric-negative { color: var(--cyber-red); text-shadow: 0 0 10px var(--cyber-red); }
        .metric-neutral { color: var(--cyber-cyan); text-shadow: 0 0 10px var(--cyber-cyan); }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top-color: var(--cyber-cyan);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .nav-link {
            color: var(--text-secondary);
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            transition: all 0.3s ease;
            position: relative;
        }

        .nav-link:hover, .nav-link.active {
            color: var(--cyber-cyan);
            text-shadow: 0 0 10px var(--cyber-cyan);
        }

        .nav-link.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 50%;
            transform: translateX(-50%);
            width: 20px;
            height: 2px;
            background: var(--cyber-cyan);
            box-shadow: 0 0 10px var(--cyber-cyan);
        }

        /* Form Styles */
        .form-input {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            color: var(--text-primary);
            padding: 0.75rem;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            border-color: var(--cyber-cyan);
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.3);
            outline: none;
        }

        .form-input:invalid {
            border-color: var(--cyber-red);
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            max-width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        /* Allocation Slider */
        .allocation-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.2);
            outline: none;
        }

        .allocation-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--cyber-cyan);
            cursor: pointer;
            box-shadow: 0 0 10px var(--cyber-cyan);
        }

        .allocation-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--cyber-cyan);
            cursor: pointer;
            border: none;
            box-shadow: 0 0 10px var(--cyber-cyan);
        }

        /* Accessibility */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        button:focus, a:focus, input:focus, select:focus {
            outline: 2px solid var(--cyber-cyan);
            outline-offset: 2px;
        }

        /* Mobile Optimizations */
        @media (max-width: 768px) {
            .comparison-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .modal-content {
                max-width: 95vw;
                margin: 1rem;
            }
        }

        /* High contrast mode support */
        @media (prefers-contrast: high) {
            :root {
                --text-primary: #ffffff;
                --bg-primary: #000000;
            }
        }

        /* Reduced motion support */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
    </style>
</head>
<body>
    <!-- Skip to main content -->
    <a href="#main-content" class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 cyberpunk-button">
        Skip to main content
    </a>

    <!-- Header -->
    <header class="bg-black/50 backdrop-blur-sm border-b border-pink-500/30 sticky top-0 z-50">
        <div class="container mx-auto px-4 py-4">
            <div class="text-center md:text-left">
                <h1 class="text-3xl md:text-4xl font-bold glow-text mb-1">
                    Portfolio Comparison
                </h1>
                <p class="text-lg text-gray-400">Create and compare custom investment scenarios</p>
            </div>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="bg-black/30 backdrop-blur-sm" role="navigation" aria-label="Main navigation">
        <div class="container mx-auto px-4">
            <div class="flex flex-wrap justify-center space-x-1 md:space-x-4 py-3">
                <a href="/dashboard" class="nav-link">
                    <span class="hidden sm:inline">Dashboard</span>
                    <span class="sm:hidden">üìä</span>
                </a>
                <a href="/upload" class="nav-link">
                    <span class="hidden sm:inline">Upload Data</span>
                    <span class="sm:hidden">üì§</span>
                </a>
                <a href="/analysis" class="nav-link">
                    <span class="hidden sm:inline">Analysis</span>
                    <span class="sm:hidden">üìà</span>
                </a>
                <a href="/comparison" class="nav-link active">
                    <span class="hidden sm:inline">Compare</span>
                    <span class="sm:hidden">‚öñÔ∏è</span>
                </a>
            </div>
        </div>
    </nav>

    <!-- Status Messages -->
    <div id="status-messages" class="container mx-auto px-4" aria-live="polite" aria-atomic="true"></div>

    <!-- Main Content -->
    <main id="main-content" class="container mx-auto px-4 py-8" role="main">
        <!-- Portfolio Tabs -->
        <div class="mb-8">
            <div class="flex flex-wrap justify-center space-x-2 md:space-x-4" role="tablist">
                <button class="comparison-tab active px-6 py-3 cyberpunk-button" data-tab="create">
                    Create Portfolio
                </button>
                <button class="comparison-tab px-6 py-3 cyberpunk-button" data-tab="compare">
                    Compare Portfolios
                </button>
                <button class="comparison-tab px-6 py-3 cyberpunk-button" data-tab="scenarios">
                    Investment Scenarios
                </button>
            </div>
        </div>

        <!-- Create Portfolio Tab -->
        <section id="create-tab" class="comparison-section" role="tabpanel">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Portfolio Creation Form -->
                <div class="cyberpunk-card p-6">
                    <div class="scanlines"></div>
                    <h2 class="text-2xl font-bold mb-6 glow-text">Create Custom Portfolio</h2>

                    <form id="portfolio-form" class="space-y-6">
                        <!-- Basic Info -->
                        <div>
                            <label for="portfolio-name" class="block text-sm font-bold mb-2 glow-text-pink">
                                Portfolio Name *
                            </label>
                            <input type="text" id="portfolio-name" name="name" class="form-input w-full" required
                                   placeholder="e.g., My Tech Portfolio" aria-describedby="name-help">
                            <p id="name-help" class="text-xs text-gray-400 mt-1">Choose a descriptive name for your portfolio</p>
                        </div>

                        <div>
                            <label for="portfolio-description" class="block text-sm font-bold mb-2 glow-text-pink">
                                Description
                            </label>
                            <textarea id="portfolio-description" name="description" class="form-input w-full h-20"
                                      placeholder="Optional description of your investment strategy"></textarea>
                        </div>

                        <!-- Strategy Selection -->
                        <div>
                            <label class="block text-sm font-bold mb-2 glow-text-pink">
                                Investment Strategy *
                            </label>
                            <div class="space-y-2">
                                <label class="flex items-center">
                                    <input type="radio" name="strategy" value="lump_sum" checked class="mr-3">
                                    <span>Lump Sum Investment</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="strategy" value="dollar_cost_average" class="mr-3">
                                    <span>Dollar-Cost Averaging</span>
                                </label>
                            </div>
                        </div>

                        <!-- Investment Amount -->
                        <div>
                            <label for="monthly-investment" class="block text-sm font-bold mb-2 glow-text-pink">
                                Monthly Investment ($)
                            </label>
                            <input type="number" id="monthly-investment" name="monthly_investment"
                                   class="form-input w-full" min="0" step="0.01"
                                   placeholder="0.00" aria-describedby="investment-help">
                            <p id="investment-help" class="text-xs text-gray-400 mt-1">
                                Amount to invest monthly (leave empty for lump sum only)
                            </p>
                        </div>

                        <!-- Asset Allocation -->
                        <div>
                            <label class="block text-sm font-bold mb-4 glow-text-pink">
                                Asset Allocation *
                            </label>
                            <div id="allocation-inputs" class="space-y-4">
                                <!-- Dynamic allocation inputs will be added here -->
                            </div>

                            <button type="button" id="add-asset-btn" class="cyberpunk-button-secondary mt-4 px-4 py-2 text-sm">
                                + Add Asset
                            </button>

                            <div class="mt-4 p-3 bg-gray-800/30 rounded">
                                <div class="flex justify-between text-sm">
                                    <span>Total Allocation:</span>
                                    <span id="allocation-total" class="font-bold glow-text">0%</span>
                                </div>
                            </div>
                        </div>

                        <!-- Form Actions -->
                        <div class="flex flex-col sm:flex-row gap-4 pt-4">
                            <button type="submit" class="cyberpunk-button flex-1">
                                Create Portfolio
                            </button>
                            <button type="button" id="clear-form-btn" class="cyberpunk-button-secondary flex-1">
                                Clear Form
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Portfolio Preview -->
                <div class="cyberpunk-card p-6">
                    <div class="scanlines"></div>
                    <h2 class="text-2xl font-bold mb-6 glow-text">Portfolio Preview</h2>

                    <div id="portfolio-preview" class="space-y-6">
                        <div class="text-center text-gray-400">
                            <p>Portfolio preview will appear here</p>
                            <p class="text-sm">Fill out the form to see your allocation</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Compare Portfolios Tab -->
        <section id="compare-tab" class="comparison-section hidden" role="tabpanel">
            <div class="grid grid-cols-1 xl:grid-cols-2 gap-8">
                <!-- Portfolio Selection -->
                <div class="cyberpunk-card p-6">
                    <div class="scanlines"></div>
                    <h2 class="text-2xl font-bold mb-6 glow-text">Select Portfolios to Compare</h2>

                    <div class="space-y-4">
                        <!-- Portfolio 1 -->
                        <div>
                            <label class="block text-sm font-bold mb-2 glow-text-pink">
                                Portfolio 1
                            </label>
                            <select id="portfolio-1" class="form-input w-full" aria-describedby="portfolio-1-help">
                                <option value="">Select a portfolio...</option>
                                <option value="robinhood">Your Robinhood Portfolio</option>
                                <!-- Custom portfolios will be populated here -->
                            </select>
                            <p id="portfolio-1-help" class="text-xs text-gray-400 mt-1">
                                Choose your first portfolio for comparison
                            </p>
                        </div>

                        <!-- Portfolio 2 -->
                        <div>
                            <label class="block text-sm font-bold mb-2 glow-text-pink">
                                Portfolio 2
                            </label>
                            <select id="portfolio-2" class="form-input w-full" aria-describedby="portfolio-2-help">
                                <option value="">Select a portfolio...</option>
                                <option value="robinhood">Your Robinhood Portfolio</option>
                                <!-- Custom portfolios will be populated here -->
                            </select>
                            <p id="portfolio-2-help" class="text-xs text-gray-400 mt-1">
                                Choose your second portfolio for comparison
                            </p>
                        </div>

                        <!-- Compare Button -->
                        <button id="compare-btn" class="cyberpunk-button w-full mt-6" disabled>
                            Compare Portfolios
                        </button>
                    </div>
                </div>

                <!-- Comparison Results -->
                <div class="cyberpunk-card p-6">
                    <div class="scanlines"></div>
                    <h2 class="text-2xl font-bold mb-6 glow-text">Comparison Results</h2>

                    <div id="comparison-results" class="space-y-6">
                        <div class="text-center text-gray-400">
                            <p>Select two portfolios to compare</p>
                            <p class="text-sm">Results will appear here</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Comparison Charts -->
            <div id="comparison-charts" class="hidden mt-8 space-y-8">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Performance Comparison -->
                    <div class="cyberpunk-card p-6">
                        <div class="scanlines"></div>
                        <h3 class="text-lg font-bold mb-4 glow-text">Performance Comparison</h3>
                        <div id="performance-comparison-chart" class="h-80">
                            <div class="flex items-center justify-center h-full">
                                <div class="loading-spinner mx-auto mb-4"></div>
                                <p class="text-gray-400">Loading comparison...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Returns Comparison -->
                    <div class="cyberpunk-card p-6">
                        <div class="scanlines"></div>
                        <h3 class="text-lg font-bold mb-4 glow-text">Total Returns Comparison</h3>
                        <div id="returns-comparison-chart" class="h-80">
                            <div class="flex items-center justify-center h-full">
                                <div class="loading-spinner mx-auto mb-4"></div>
                                <p class="text-gray-400">Loading comparison...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
                    <!-- Risk Comparison -->
                    <div class="cyberpunk-card p-6">
                        <div class="scanlines"></div>
                        <h3 class="text-lg font-bold mb-4 glow-text">Risk Comparison</h3>
                        <div id="risk-comparison-chart" class="h-80">
                            <div class="flex items-center justify-center h-full">
                                <div class="loading-spinner mx-auto mb-4"></div>
                                <p class="text-gray-400">Loading comparison...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Risk-Return Scatter Plot -->
                <div class="cyberpunk-card p-6">
                    <div class="scanlines"></div>
                    <h3 class="text-lg font-bold mb-4 glow-text">Risk-Return Profile</h3>
                    <div id="risk-return-scatter" class="h-80">
                        <div class="flex items-center justify-center h-full">
                            <div class="loading-spinner mx-auto mb-4"></div>
                            <p class="text-gray-400">Loading risk-return analysis...</p>
                        </div>
                    </div>
                </div>

                <!-- Comparative Timeline -->
                <div class="cyberpunk-card p-6">
                    <div class="scanlines"></div>
                    <h3 class="text-lg font-bold mb-4 glow-text">Comparative Performance Timeline</h3>
                    <div id="comparative-timeline" class="h-80">
                        <div class="flex items-center justify-center h-full">
                            <div class="loading-spinner mx-auto mb-4"></div>
                            <p class="text-gray-400">Loading timeline comparison...</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Investment Scenarios Tab -->
        <section id="scenarios-tab" class="comparison-section hidden" role="tabpanel">
            <div class="grid grid-cols-1 xl:grid-cols-2 gap-8">
                <!-- Scenario Builder -->
                <div class="cyberpunk-card p-6">
                    <div class="scanlines"></div>
                    <h2 class="text-2xl font-bold mb-6 glow-text">Build Investment Scenario</h2>

                    <div class="space-y-6">
                        <!-- Base Portfolio -->
                        <div>
                            <label class="block text-sm font-bold mb-2 glow-text-pink">
                                Base Portfolio
                            </label>
                            <select id="base-portfolio" class="form-input w-full">
                                <option value="robinhood">Your Robinhood Portfolio</option>
                                <!-- Custom portfolios will be populated here -->
                            </select>
                        </div>

                        <!-- Scenario Type -->
                        <div>
                            <label class="block text-sm font-bold mb-2 glow-text-pink">
                                Scenario Type
                            </label>
                            <select id="scenario-type" class="form-input w-full">
                                <option value="rebalance">Rebalance Portfolio</option>
                                <option value="add_asset">Add New Asset</option>
                                <option value="reduce_position">Reduce Position</option>
                                <option value="market_change">Market Change</option>
                            </select>
                        </div>

                        <!-- Scenario Parameters -->
                        <div id="scenario-params" class="space-y-4">
                            <!-- Dynamic parameters based on scenario type -->
                        </div>

                        <!-- Run Scenario -->
                        <button id="run-scenario-btn" class="cyberpunk-button w-full">
                            Run Scenario Analysis
                        </button>
                    </div>
                </div>

                <!-- Scenario Results -->
                <div class="cyberpunk-card p-6">
                    <div class="scanlines"></div>
                    <h2 class="text-2xl font-bold mb-6 glow-text">Scenario Results</h2>

                    <div id="scenario-results" class="space-y-6">
                        <div class="text-center text-gray-400">
                            <p>Configure and run a scenario</p>
                            <p class="text-sm">Results will appear here</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Asset Allocation Modal -->
    <div id="allocation-modal" class="modal-overlay hidden">
        <div class="modal-content w-full max-w-md">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold glow-text">Add Asset</h3>
                    <button onclick="closeAllocationModal()" class="text-gray-400 hover:text-white" aria-label="Close modal">
                        ‚úï
                    </button>
                </div>

                <div class="space-y-4">
                    <div>
                        <label for="asset-ticker" class="block text-sm font-bold mb-2">
                            Asset Ticker *
                        </label>
                        <input type="text" id="asset-ticker" class="form-input w-full" placeholder="e.g., AAPL, SPY"
                               aria-describedby="ticker-help">
                        <p id="ticker-help" class="text-xs text-gray-400 mt-1">
                            Enter a valid stock ticker symbol
                        </p>
                    </div>

                    <div>
                        <label for="asset-weight" class="block text-sm font-bold mb-2">
                            Weight (%) *
                        </label>
                        <input type="number" id="asset-weight" class="form-input w-full" min="0" max="100" step="0.1"
                               placeholder="0.0" aria-describedby="weight-help">
                        <p id="weight-help" class="text-xs text-gray-400 mt-1">
                            Percentage allocation for this asset
                        </p>
                    </div>

                    <div class="flex gap-4">
                        <button onclick="addAsset()" class="cyberpunk-button flex-1">
                            Add Asset
                        </button>
                        <button onclick="closeAllocationModal()" class="cyberpunk-button-secondary flex-1">
                            Cancel
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Educational Modal -->
    <div id="education-modal" class="modal-overlay hidden">
        <div class="modal-content w-full max-w-2xl">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 id="modal-title" class="text-xl font-bold glow-text">Portfolio Education</h3>
                    <button onclick="closeEducationModal()" class="text-gray-400 hover:text-white" aria-label="Close modal">
                        ‚úï
                    </button>
                </div>

                <div id="modal-content" class="space-y-4">
                    <!-- Content will be populated by JavaScript -->
                </div>

                <div class="mt-6 text-right">
                    <button onclick="closeEducationModal()" class="cyberpunk-button-secondary px-4 py-2">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let portfolios = [];
        let currentAllocations = {};
        let allocationInputs = [];

        // DOM Content Loaded
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            loadPortfolios();
            initializeForm();
        });

        // Setup event listeners
        function setupEventListeners() {
            // Tab switching
            document.querySelectorAll('.comparison-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    switchTab(this.dataset.tab);
                });
            });

            // Portfolio form
            document.getElementById('portfolio-form').addEventListener('submit', handlePortfolioSubmit);
            document.getElementById('clear-form-btn').addEventListener('click', clearForm);
            document.getElementById('add-asset-btn').addEventListener('click', openAllocationModal);

            // Comparison
            document.getElementById('portfolio-1').addEventListener('change', updateCompareButton);
            document.getElementById('portfolio-2').addEventListener('change', updateCompareButton);
            document.getElementById('compare-btn').addEventListener('click', runComparison);

            // Scenarios
            document.getElementById('scenario-type').addEventListener('change', updateScenarioParams);
            document.getElementById('run-scenario-btn').addEventListener('click', runScenario);

            // Keyboard navigation
            document.addEventListener('keydown', handleKeyboardNavigation);
        }

        // Handle keyboard navigation
        function handleKeyboardNavigation(event) {
            if (event.key === 'Escape') {
                closeAllocationModal();
                closeEducationModal();
            }
        }

        // Switch between tabs
        function switchTab(tabName) {
            // Hide all sections
            document.querySelectorAll('.comparison-section').forEach(section => {
                section.classList.add('hidden');
            });

            // Remove active class from all tabs
            document.querySelectorAll('.comparison-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected section and activate tab
            document.getElementById(tabName + '-tab').classList.remove('hidden');
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
        }

        // Load available portfolios
        async function loadPortfolios() {
            try {
                const response = await fetch('/api/custom-portfolios');
                if (response.ok) {
                    portfolios = await response.json();
                    populatePortfolioSelects();
                }
            } catch (error) {
                console.error('Error loading portfolios:', error);
            }
        }

        // Populate portfolio select dropdowns
        function populatePortfolioSelects() {
            const selects = ['portfolio-1', 'portfolio-2', 'base-portfolio'];

            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                // Clear existing options except first
                while (select.children.length > 1) {
                    select.removeChild(select.lastChild);
                }

                // Add custom portfolios
                portfolios.forEach(portfolio => {
                    const option = document.createElement('option');
                    option.value = portfolio.id;
                    option.textContent = portfolio.name;
                    select.appendChild(option);
                });
            });
        }

        // Initialize portfolio creation form
        function initializeForm() {
            // Add initial asset input
            addAllocationInput('AAPL', 50);
            addAllocationInput('MSFT', 30);
            addAllocationInput('GOOGL', 20);

            updateAllocationTotal();
        }

        // Add allocation input
        function addAllocationInput(ticker = '', weight = 0) {
            const container = document.getElementById('allocation-inputs');
            const inputId = 'allocation-' + allocationInputs.length;

            const inputHtml = `
                <div class="allocation-input flex items-center space-x-4 p-3 bg-gray-800/30 rounded" data-id="${inputId}">
                    <div class="flex-1">
                        <label class="block text-xs text-gray-400 mb-1">Asset</label>
                        <input type="text" class="form-input w-full asset-ticker" value="${ticker}"
                               placeholder="e.g., AAPL" aria-label="Asset ticker">
                    </div>
                    <div class="w-24">
                        <label class="block text-xs text-gray-400 mb-1">Weight %</label>
                        <input type="number" class="form-input w-full asset-weight" value="${weight}"
                               min="0" max="100" step="0.1" aria-label="Asset weight percentage">
                    </div>
                    <button type="button" class="remove-asset-btn text-red-400 hover:text-red-300 mt-6"
                            onclick="removeAllocationInput('${inputId}')" aria-label="Remove asset">
                        ‚úï
                    </button>
                </div>
            `;

            container.insertAdjacentHTML('beforeend', inputHtml);
            allocationInputs.push(inputId);

            // Add event listeners
            const newInput = container.lastElementChild;
            const tickerInput = newInput.querySelector('.asset-ticker');
            const weightInput = newInput.querySelector('.asset-weight');

            tickerInput.addEventListener('input', updateAllocationTotal);
            weightInput.addEventListener('input', updateAllocationTotal);

            updateAllocationTotal();
        }

        // Remove allocation input
        function removeAllocationInput(inputId) {
            const input = document.querySelector(`[data-id="${inputId}"]`);
            if (input) {
                input.remove();
                allocationInputs = allocationInputs.filter(id => id !== inputId);
                updateAllocationTotal();
            }
        }

        // Update allocation total
        function updateAllocationTotal() {
            let total = 0;
            document.querySelectorAll('.asset-weight').forEach(input => {
                const value = parseFloat(input.value) || 0;
                total += value;
            });

            const totalElement = document.getElementById('allocation-total');
            totalElement.textContent = total.toFixed(1) + '%';

            // Update color based on total
            if (Math.abs(total - 100) < 0.1) {
                totalElement.className = 'font-bold text-green-400';
            } else if (total > 100) {
                totalElement.className = 'font-bold text-red-400';
            } else {
                totalElement.className = 'font-bold text-yellow-400';
            }
        }

        // Open allocation modal
        function openAllocationModal() {
            const modal = document.getElementById('allocation-modal');
            if (modal) modal.style.display = 'flex';
            document.getElementById('asset-ticker').focus();
        }

        // Close allocation modal
        function closeAllocationModal() {
            const modal = document.getElementById('allocation-modal');
            if (modal) modal.style.display = 'none';
            document.getElementById('asset-ticker').value = '';
            document.getElementById('asset-weight').value = '';
        }

        // Add asset from modal
        function addAsset() {
            const ticker = document.getElementById('asset-ticker').value.trim().toUpperCase();
            const weight = parseFloat(document.getElementById('asset-weight').value) || 0;

            if (!ticker) {
                showStatusMessage('Please enter an asset ticker', 'error');
                return;
            }

            if (weight <= 0 || weight > 100) {
                showStatusMessage('Please enter a valid weight between 0 and 100', 'error');
                return;
            }

            addAllocationInput(ticker, weight);
            closeAllocationModal();
        }

        // Handle portfolio form submission
        async function handlePortfolioSubmit(e) {
            e.preventDefault();

            const formData = new FormData(e.target);
            const allocations = {};

            // Collect allocations
            document.querySelectorAll('.allocation-input').forEach(input => {
                const ticker = input.querySelector('.asset-ticker').value.trim().toUpperCase();
                const weight = parseFloat(input.querySelector('.asset-weight').value) || 0;

                if (ticker && weight > 0) {
                    allocations[ticker] = weight;
                }
            });

            // Validate allocations total
            const totalWeight = Object.values(allocations).reduce((sum, weight) => sum + weight, 0);
            if (Math.abs(totalWeight - 100) > 0.1) {
                showStatusMessage('Asset allocations must total 100%', 'error');
                return;
            }

            // Convert weights to decimals (API expects 0.0-1.0, not percentages)
            const assetAllocation = {};
            Object.keys(allocations).forEach(ticker => {
                assetAllocation[ticker] = allocations[ticker] / 100.0;
            });

            // Prepare portfolio data
            const portfolioData = {
                name: formData.get('name'),
                description: formData.get('description'),
                strategy: formData.get('strategy'),
                asset_allocation: assetAllocation,
                monthly_investment: parseFloat(formData.get('monthly_investment')) || null
            };

            try {
                showStatusMessage('Creating portfolio...', 'info');

                const response = await fetch('/api/custom-portfolios', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(portfolioData)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to create portfolio');
                }

                const result = await response.json();
                showStatusMessage('Portfolio created successfully!', 'success');

                // Reload portfolios and switch to compare tab
                await loadPortfolios();
                switchTab('compare');

                // Clear form
                clearForm();

            } catch (error) {
                console.error('Error creating portfolio:', error);
                showStatusMessage(error.message, 'error');
            }
        }

        // Clear portfolio form
        function clearForm() {
            document.getElementById('portfolio-form').reset();
            document.getElementById('allocation-inputs').innerHTML = '';
            allocationInputs = [];
            initializeForm();
        }

        // Update portfolio preview
        function updatePortfolioPreview() {
            const preview = document.getElementById('portfolio-preview');
            const name = document.getElementById('portfolio-name').value;
            const strategy = document.querySelector('input[name="strategy"]:checked').value;
            const monthlyInvestment = parseFloat(document.getElementById('monthly-investment').value) || 0;

            let allocations = [];
            document.querySelectorAll('.allocation-input').forEach(input => {
                const ticker = input.querySelector('.asset-ticker').value.trim().toUpperCase();
                const weight = parseFloat(input.querySelector('.asset-weight').value) || 0;

                if (ticker && weight > 0) {
                    allocations.push({ticker, weight});
                }
            });

            if (allocations.length === 0) {
                preview.innerHTML = `
                    <div class="text-center text-gray-400">
                        <p>Portfolio preview will appear here</p>
                        <p class="text-sm">Add assets to see your allocation</p>
                    </div>
                `;
                return;
            }

            let html = `
                <div class="mb-4">
                    <h3 class="text-lg font-bold glow-text mb-2">${name || 'Untitled Portfolio'}</h3>
                    <p class="text-sm text-gray-400">Strategy: ${strategy === 'lump_sum' ? 'Lump Sum' : 'Dollar-Cost Average'}</p>
                    ${monthlyInvestment > 0 ? `<p class="text-sm text-gray-400">Monthly Investment: $${monthlyInvestment.toFixed(2)}</p>` : ''}
                </div>

                <div class="space-y-2">
                    <h4 class="font-bold text-sm glow-text-pink">Asset Allocation:</h4>
            `;

            allocations.forEach(allocation => {
                html += `
                    <div class="flex justify-between items-center p-2 bg-gray-800/30 rounded">
                        <span class="font-mono">${allocation.ticker}</span>
                        <span class="text-cyan-400">${allocation.weight.toFixed(1)}%</span>
                    </div>
                `;
            });

            html += '</div>';
            preview.innerHTML = html;
        }

        // Update compare button state
        function updateCompareButton() {
            const portfolio1 = document.getElementById('portfolio-1').value;
            const portfolio2 = document.getElementById('portfolio-2').value;
            const compareBtn = document.getElementById('compare-btn');

            compareBtn.disabled = !portfolio1 || !portfolio2 || portfolio1 === portfolio2;
        }

        // Run portfolio comparison
        async function runComparison() {
            const portfolio1 = document.getElementById('portfolio-1').value;
            const portfolio2 = document.getElementById('portfolio-2').value;

            if (!portfolio1 || !portfolio2) return;

            try {
                showStatusMessage('Comparing portfolios...', 'info');

                // Build comparison request with support for benchmarks
                const comparisonRequest = {
                    portfolio_ids: [parseInt(portfolio1), parseInt(portfolio2)],
                    include_robinhood: true,  // Always include Robinhood for comparison
                    benchmark_tickers: ['SPY'],  // Default to SPY benchmark
                    initial_investment: 10000.0
                };

                const response = await fetch('/api/portfolio-comparison', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(comparisonRequest)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to compare portfolios');
                }

                const comparison = await response.json();
                displayComparisonResults(comparison);

            } catch (error) {
                console.error('Error comparing portfolios:', error);
                showStatusMessage(error.message || 'Error comparing portfolios', 'error');
            }
        }

        // Display comparison results
        function displayComparisonResults(comparison) {
            const container = document.getElementById('comparison-results');

            // Show charts section
            document.getElementById('comparison-charts').classList.remove('hidden');

            // Display metrics comparison for all portfolios
            let metricsHtml = '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">';
            
            comparison.portfolios.forEach((portfolio, index) => {
                const colorClass = index === 0 ? 'text-cyan-400' : index === 1 ? 'text-pink-400' : 'text-yellow-400';
                metricsHtml += `
                    <div class="p-4 bg-gray-800/50 rounded border border-${colorClass.replace('text-', '')}/30">
                        <h4 class="font-bold ${colorClass} mb-2">${portfolio.portfolio_name || portfolio.name || 'Portfolio ' + (index + 1)}</h4>
                        <div class="space-y-2 text-sm">
                            <div>Total Return: <span class="font-mono ${colorClass}">${portfolio.total_return?.toFixed(2) || 0}%</span></div>
                            <div>Final Value: <span class="font-mono ${colorClass}">$${portfolio.final_value?.toLocaleString() || 0}</span></div>
                            ${portfolio.sharpe_ratio ? `<div>Sharpe Ratio: <span class="font-mono ${colorClass}">${portfolio.sharpe_ratio.toFixed(3)}</span></div>` : ''}
                            ${portfolio.max_drawdown ? `<div>Max Drawdown: <span class="font-mono text-red-400">${portfolio.max_drawdown.toFixed(2)}%</span></div>` : ''}
                        </div>
                    </div>
                `;
            });
            
            metricsHtml += '</div>';
            container.innerHTML = metricsHtml;

            // Create comparison charts
            createComparisonCharts(comparison);
        }

        // Create comparison charts
        function createComparisonCharts(comparison) {
            const colors = ['#ff00ff', '#00ffff', '#ffff00', '#00ff00', '#ff0040'];
            
            // Performance comparison chart - line chart showing value over time
            const performanceTraces = comparison.portfolios.map((portfolio, index) => {
                const history = portfolio.history || [];
                return {
                    type: 'scatter',
                    mode: 'lines',
                    name: portfolio.portfolio_name || portfolio.name || `Portfolio ${index + 1}`,
                    x: history.map(h => h.date),
                    y: history.map(h => h.value),
                    line: {color: colors[index % colors.length], width: 2},
                    hovertemplate: '<b>%{fullData.name}</b><br>Date: %{x}<br>Value: $%{y:,.2f}<extra></extra>'
                };
            });

            const performanceLayout = {
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                font: {color: '#e0e0e0'},
                title: {
                    text: 'Portfolio Value Over Time',
                    font: {color: '#00ffff', size: 16}
                },
                xaxis: {
                    title: 'Date',
                    gridcolor: 'rgba(255,255,255,0.1)'
                },
                yaxis: {
                    title: 'Portfolio Value ($)',
                    gridcolor: 'rgba(255,255,255,0.1)'
                },
                legend: {
                    font: {color: '#e0e0e0'},
                    bgcolor: 'rgba(0,0,0,0.5)'
                },
                margin: {t: 60, r: 10, b: 50, l: 70}
            };

            Plotly.newPlot('performance-comparison-chart', performanceTraces, performanceLayout, {responsive: true});

            // Total return bar chart
            const returnData = [{
                type: 'bar',
                x: comparison.portfolios.map(p => p.portfolio_name || p.name || 'Portfolio'),
                y: comparison.portfolios.map(p => p.total_return || 0),
                marker: {
                    color: comparison.portfolios.map((_, i) => colors[i % colors.length]),
                    line: {color: 'rgba(255,255,255,0.3)', width: 1}
                },
                hovertemplate: '%{x}<br>Total Return: %{y:.2f}%<extra></extra>'
            }];

            const returnLayout = {
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                font: {color: '#e0e0e0'},
                title: {
                    text: 'Total Returns Comparison',
                    font: {color: '#00ffff', size: 14}
                },
                yaxis: {
                    title: 'Total Return (%)',
                    gridcolor: 'rgba(255,255,255,0.1)'
                },
                margin: {t: 50, r: 10, b: 40, l: 60}
            };

            Plotly.newPlot('returns-comparison-chart', returnData, returnLayout, {responsive: true});

            // Risk comparison chart
            const riskData = [{
                type: 'bar',
                x: [comparison.portfolios[0].name, comparison.portfolios[1].name],
                y: [comparison.portfolios[0].volatility || 0, comparison.portfolios[1].volatility || 0],
                marker: {
                    color: ['#ff0040', '#ffff00'],
                    line: {color: 'rgba(255,255,255,0.3)', width: 1}
                },
                hovertemplate: '%{x}<br>Volatility: %{y:.2f}%<extra></extra>'
            }];

            const riskLayout = {
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                font: {color: '#e0e0e0'},
                title: {
                    text: 'Risk Comparison (Volatility)',
                    font: {color: '#00ffff', size: 14}
                },
                yaxis: {
                    title: 'Volatility (%)',
                    gridcolor: 'rgba(255,255,255,0.1)'
                },
                margin: {t: 50, r: 10, b: 40, l: 60}
            };

            Plotly.newPlot('risk-comparison-chart', riskData, riskLayout, {responsive: true});

            // Create risk-return scatter plot
            createRiskReturnScatter(comparison);

            // Create comparative timeline
            createComparativeTimeline(comparison);
        }

        // Create risk-return scatter plot with real benchmark data
        async function createRiskReturnScatter(comparison) {
            const container = document.getElementById('risk-return-scatter');
            const colors = ['#ff00ff', '#00ffff', '#00ff00', '#ffff00', '#ff0040'];

            // Try to fetch real benchmark data
            let benchmarkReturn = 8.5;  // Default S&P 500 average
            let benchmarkRisk = 15.0;   // Default S&P 500 volatility
            
            try {
                // Fetch real SPY data for the same period
                const startDate = comparison.start_date || new Date(Date.now() - 365*24*60*60*1000).toISOString().split('T')[0];
                const endDate = comparison.end_date || new Date().toISOString().split('T')[0];
                
                const benchmarkResponse = await fetch(`/api/benchmarks/SPY?start_date=${startDate}&end_date=${endDate}&initial_investment=10000`);
                if (benchmarkResponse.ok) {
                    const benchmarkData = await benchmarkResponse.json();
                    if (benchmarkData.total_return !== undefined) {
                        benchmarkReturn = benchmarkData.total_return;
                    }
                    // Estimate volatility from history if available
                    if (benchmarkData.history && benchmarkData.history.length > 10) {
                        const returns = [];
                        for (let i = 1; i < benchmarkData.history.length; i++) {
                            const prevValue = benchmarkData.history[i-1].value;
                            const currValue = benchmarkData.history[i].value;
                            if (prevValue > 0) {
                                returns.push((currValue - prevValue) / prevValue);
                            }
                        }
                        if (returns.length > 0) {
                            const mean = returns.reduce((a, b) => a + b, 0) / returns.length;
                            const variance = returns.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / returns.length;
                            benchmarkRisk = Math.sqrt(variance) * Math.sqrt(252) * 100;  // Annualized
                        }
                    }
                }
            } catch (e) {
                console.log('Using default benchmark values:', e);
            }

            // Build portfolio points
            const portfolioX = [];
            const portfolioY = [];
            const portfolioNames = [];
            const portfolioColors = [];
            
            comparison.portfolios.forEach((portfolio, index) => {
                portfolioX.push(portfolio.volatility || portfolio.max_drawdown || 10);
                portfolioY.push(portfolio.total_return || 0);
                portfolioNames.push(portfolio.portfolio_name || portfolio.name || `Portfolio ${index + 1}`);
                portfolioColors.push(colors[index % colors.length]);
            });

            const data = [
                // Portfolio points
                {
                    x: portfolioX,
                    y: portfolioY,
                    mode: 'markers+text',
                    type: 'scatter',
                    name: 'Portfolios',
                    text: portfolioNames,
                    textposition: 'top center',
                    marker: {
                        size: 14,
                        color: portfolioColors,
                        line: {color: 'rgba(255,255,255,0.5)', width: 2}
                    },
                    hovertemplate: '<b>%{text}</b><br>Risk: %{x:.1f}%<br>Return: %{y:.1f}%<extra></extra>'
                },
                // Benchmark point
                {
                    x: [benchmarkRisk],
                    y: [benchmarkReturn],
                    mode: 'markers+text',
                    type: 'scatter',
                    name: 'S&P 500 Benchmark',
                    text: ['SPY'],
                    textposition: 'top center',
                    marker: {
                        size: 12,
                        color: '#ffff00',
                        symbol: 'diamond',
                        line: {color: 'rgba(255,255,255,0.5)', width: 2}
                    },
                    hovertemplate: '<b>S&P 500</b><br>Risk: %{x:.1f}%<br>Return: %{y:.1f}%<extra></extra>'
                }
            ];

            const layout = {
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                font: {color: '#e0e0e0'},
                title: {
                    text: 'Risk vs Return Analysis',
                    font: {color: '#00ffff', size: 14}
                },
                xaxis: {
                    title: 'Risk (Volatility %)',
                    gridcolor: 'rgba(255,255,255,0.1)'
                },
                yaxis: {
                    title: 'Return (%)',
                    gridcolor: 'rgba(255,255,255,0.1)'
                },
                margin: {t: 50, r: 10, b: 40, l: 60},
                showlegend: true,
                legend: {
                    x: 0.02,
                    y: 0.98,
                    bgcolor: 'rgba(0,0,0,0.5)',
                    bordercolor: 'rgba(255,255,255,0.2)',
                    borderwidth: 1
                },
                annotations: [{
                    text: 'Higher return for same risk = Better',
                    showarrow: false,
                    x: 0.02,
                    y: 0.02,
                    xref: 'paper',
                    yref: 'paper',
                    font: {size: 10, color: '#888888'}
                }]
            };

            Plotly.newPlot('risk-return-scatter', data, layout, {responsive: true});
        }

        // Create comparative timeline using real history data from comparison
        function createComparativeTimeline(comparison) {
            const container = document.getElementById('comparative-timeline');
            const colors = ['#ff00ff', '#00ffff', '#ffff00', '#00ff00', '#ff0040'];

            // Build traces from actual portfolio history data
            const traces = [];
            
            comparison.portfolios.forEach((portfolio, index) => {
                const history = portfolio.history || [];
                
                if (history.length > 0) {
                    // Use actual history data
                    traces.push({
                        x: history.map(h => h.date),
                        y: history.map(h => h.value),
                        type: 'scatter',
                        mode: 'lines',
                        name: portfolio.portfolio_name || portfolio.name || `Portfolio ${index + 1}`,
                        line: {color: colors[index % colors.length], width: 2},
                        hovertemplate: '<b>%{fullData.name}</b><br>Date: %{x}<br>Value: $%{y:,.2f}<extra></extra>'
                    });
                } else {
                    // Fallback: generate interpolated data from start/end values
                    const startValue = portfolio.initial_investment || 10000;
                    const endValue = portfolio.final_value || startValue;
                    const totalReturn = portfolio.total_return || 0;
                    
                    // Generate monthly data points
                    const startDate = new Date(comparison.start_date || Date.now() - 365*24*60*60*1000);
                    const endDate = new Date(comparison.end_date || Date.now());
                    const dates = [];
                    const values = [];
                    
                    const totalDays = (endDate - startDate) / (24*60*60*1000);
                    const numPoints = Math.min(52, Math.max(12, Math.floor(totalDays / 7)));
                    
                    for (let i = 0; i <= numPoints; i++) {
                        const progress = i / numPoints;
                        const date = new Date(startDate.getTime() + progress * (endDate - startDate));
                        dates.push(date.toISOString().split('T')[0]);
                        
                        // Linear interpolation with slight curve
                        const value = startValue + (endValue - startValue) * progress;
                        values.push(value);
                    }
                    
                    traces.push({
                        x: dates,
                        y: values,
                        type: 'scatter',
                        mode: 'lines',
                        name: portfolio.portfolio_name || portfolio.name || `Portfolio ${index + 1}`,
                        line: {color: colors[index % colors.length], width: 2, dash: 'dot'},
                        hovertemplate: '<b>%{fullData.name}</b><br>Date: %{x}<br>Value: $%{y:,.2f} (estimated)<extra></extra>'
                    });
                }
            });

            if (traces.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-400 p-4">No timeline data available</p>';
                return;
            }

            const layout = {
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                font: {color: '#e0e0e0'},
                title: {
                    text: 'Portfolio Value Comparison Over Time',
                    font: {color: '#00ffff', size: 14}
                },
                xaxis: {
                    title: 'Date',
                    gridcolor: 'rgba(255,255,255,0.1)',
                    type: 'date'
                },
                yaxis: {
                    title: 'Portfolio Value ($)',
                    gridcolor: 'rgba(255,255,255,0.1)',
                    tickformat: ',.0f'
                },
                margin: {t: 50, r: 10, b: 40, l: 70},
                showlegend: true,
                legend: {
                    x: 0.02,
                    y: 0.98,
                    bgcolor: 'rgba(0,0,0,0.5)',
                    bordercolor: 'rgba(255,255,255,0.2)',
                    borderwidth: 1
                }
            };

            Plotly.newPlot('comparative-timeline', traces, layout, {responsive: true});
        }

        // Update scenario parameters based on type
        function updateScenarioParams() {
            const scenarioType = document.getElementById('scenario-type').value;
            const paramsContainer = document.getElementById('scenario-params');

            let paramsHtml = '';

            switch (scenarioType) {
                case 'rebalance':
                    paramsHtml = `
                        <div>
                            <label class="block text-sm font-bold mb-2">Target Allocation</label>
                            <div class="space-y-2">
                                <input type="text" class="form-input w-full" placeholder="AAPL: 50, MSFT: 30, GOOGL: 20"
                                       aria-describedby="rebalance-help">
                                <p id="rebalance-help" class="text-xs text-gray-400">
                                    Enter ticker:weight pairs separated by commas
                                </p>
                            </div>
                        </div>
                    `;
                    break;

                case 'add_asset':
                    paramsHtml = `
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-bold mb-2">Asset Ticker</label>
                                <input type="text" class="form-input w-full" placeholder="e.g., TSLA">
                            </div>
                            <div>
                                <label class="block text-sm font-bold mb-2">Weight (%)</label>
                                <input type="number" class="form-input w-full" min="0" max="100" step="0.1" placeholder="10">
                            </div>
                        </div>
                    `;
                    break;

                case 'reduce_position':
                    paramsHtml = `
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-bold mb-2">Asset Ticker</label>
                                <input type="text" class="form-input w-full" placeholder="e.g., AAPL">
                            </div>
                            <div>
                                <label class="block text-sm font-bold mb-2">Reduce By (%)</label>
                                <input type="number" class="form-input w-full" min="0" max="100" step="1" placeholder="25">
                            </div>
                        </div>
                    `;
                    break;

                case 'market_change':
                    paramsHtml = `
                        <div>
                            <label class="block text-sm font-bold mb-2">Market Change (%)</label>
                            <input type="number" class="form-input w-full" step="0.1" placeholder="-10"
                                   aria-describedby="market-help">
                            <p id="market-help" class="text-xs text-gray-400">
                                Enter positive for gain, negative for loss
                            </p>
                        </div>
                    `;
                    break;
            }

            paramsContainer.innerHTML = paramsHtml;
        }

        // Run scenario analysis
        async function runScenario() {
            const basePortfolio = document.getElementById('base-portfolio').value;
            const scenarioType = document.getElementById('scenario-type').value;

            try {
                showStatusMessage('Running scenario analysis...', 'info');

                // Collect scenario parameters
                const params = collectScenarioParams(scenarioType);
                
                // Call the scenario API
                const response = await fetch('/api/scenarios', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        portfolio_id: basePortfolio === 'robinhood' ? null : parseInt(basePortfolio),
                        scenario_type: scenarioType,
                        params: params
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to run scenario');
                }

                const results = await response.json();
                
                if (results.error) {
                    showStatusMessage('Scenario completed with warnings: ' + results.error, 'warning');
                } else {
                    showStatusMessage('Scenario analysis completed!', 'success');
                }
                
                displayScenarioResults(results);

            } catch (error) {
                console.error('Error running scenario:', error);
                showStatusMessage('Error running scenario analysis: ' + error.message, 'error');
            }
        }

        // Collect scenario parameters from form inputs
        function collectScenarioParams(scenarioType) {
            const paramsContainer = document.getElementById('scenario-params');
            const inputs = paramsContainer.querySelectorAll('input');
            const params = {};
            
            switch (scenarioType) {
                case 'rebalance':
                    // Parse "AAPL: 50, MSFT: 30" format
                    const allocInput = inputs[0]?.value || '';
                    const weights = {};
                    allocInput.split(',').forEach(pair => {
                        const [ticker, weight] = pair.split(':').map(s => s.trim());
                        if (ticker && weight) {
                            weights[ticker.toUpperCase()] = parseFloat(weight) / 100;
                        }
                    });
                    params.weights = weights;
                    break;
                    
                case 'add_asset':
                    params.ticker = inputs[0]?.value || '';
                    params.weight = (parseFloat(inputs[1]?.value) || 10) / 100;
                    break;
                    
                case 'reduce_position':
                    params.ticker = inputs[0]?.value || '';
                    params.reduction = (parseFloat(inputs[1]?.value) || 25) / 100;
                    break;
                    
                case 'market_change':
                    params.change = parseFloat(inputs[0]?.value) || 0;
                    break;
            }
            
            return params;
        }

        // Display scenario results
        function displayScenarioResults(results) {
            const container = document.getElementById('scenario-results');

            let html = `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="p-4 bg-gray-800/50 rounded border border-gray-700">
                        <h4 class="font-bold glow-text mb-2">Original Portfolio</h4>
                        <div class="space-y-2 text-sm">
                            <div>Return: <span class="${results.original.return >= 0 ? 'metric-positive' : 'metric-negative'}">${results.original.return > 0 ? '+' : ''}${results.original.return}%</span></div>
                            <div>Risk: <span class="metric-neutral">${results.original.risk}%</span></div>
                            <div>Sharpe: <span class="metric-neutral">${results.original.sharpe}</span></div>
                        </div>
                    </div>
                    <div class="p-4 bg-cyan-900/20 rounded border border-cyan-500/30">
                        <h4 class="font-bold text-cyan-400 mb-2">Scenario Result</h4>
                        <div class="space-y-2 text-sm">
                            <div>Return: <span class="${results.scenario.return >= 0 ? 'metric-positive' : 'metric-negative'}">${results.scenario.return > 0 ? '+' : ''}${results.scenario.return}%</span></div>
                            <div>Risk: <span class="metric-neutral">${results.scenario.risk}%</span></div>
                            <div>Sharpe: <span class="metric-neutral">${results.scenario.sharpe}</span></div>
                        </div>
                    </div>
                    <div class="p-4 bg-gray-800/50 rounded border ${results.difference.return >= 0 ? 'border-green-500/30' : 'border-red-500/30'}">
                        <h4 class="font-bold ${results.difference.return >= 0 ? 'text-green-400' : 'text-red-400'} mb-2">Impact</h4>
                        <div class="space-y-2 text-sm">
                            <div>Return: <span class="${results.difference.return >= 0 ? 'metric-positive' : 'metric-negative'}">${results.difference.return > 0 ? '+' : ''}${results.difference.return}%</span></div>
                            <div>Risk: <span class="${results.difference.risk <= 0 ? 'text-green-400' : 'text-red-400'}">${results.difference.risk > 0 ? '+' : ''}${results.difference.risk}%</span></div>
                            <div>Sharpe: <span class="${results.difference.sharpe >= 0 ? 'text-green-400' : 'text-red-400'}">${results.difference.sharpe > 0 ? '+' : ''}${results.difference.sharpe}</span></div>
                        </div>
                    </div>
                </div>
            `;
            
            // Show allocation changes if available
            if (results.original_allocation && results.scenario_allocation) {
                html += `
                    <div class="mt-6 p-4 bg-gray-800/30 rounded">
                        <h4 class="font-bold text-cyan-400 mb-3">Allocation Changes</h4>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
                `;
                
                const allTickers = new Set([
                    ...Object.keys(results.original_allocation),
                    ...Object.keys(results.scenario_allocation)
                ]);
                
                for (const ticker of allTickers) {
                    const original = (results.original_allocation[ticker] || 0) * 100;
                    const scenario = (results.scenario_allocation[ticker] || 0) * 100;
                    const change = scenario - original;
                    
                    html += `
                        <div class="p-2 bg-gray-800/50 rounded">
                            <div class="font-mono text-cyan-400">${ticker}</div>
                            <div class="text-gray-400">${original.toFixed(1)}% ‚Üí ${scenario.toFixed(1)}%</div>
                            <div class="${change >= 0 ? 'text-green-400' : 'text-red-400'}">${change > 0 ? '+' : ''}${change.toFixed(1)}%</div>
                        </div>
                    `;
                }
                
                html += '</div></div>';
            }
            
            container.innerHTML = html;
        }

        // Show status messages
        function showStatusMessage(message, type = 'info') {
            const container = document.getElementById('status-messages');

            const messageDiv = document.createElement('div');
            messageDiv.className = `status-message status-${type}`;
            messageDiv.innerHTML = `
                <div class="flex items-center">
                    <span class="mr-2">${
                        type === 'success' ? '‚úÖ' :
                        type === 'error' ? '‚ùå' :
                        '‚ÑπÔ∏è'
                    }</span>
                    <span>${message}</span>
                </div>
            `;

            container.appendChild(messageDiv);

            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.remove();
                }
            }, 5000);
        }

        // Close education modal
        function closeEducationModal() {
            const modal = document.getElementById('education-modal');
            if (modal) modal.style.display = 'none';
        }

        // Live preview updates
        document.getElementById('portfolio-form').addEventListener('input', updatePortfolioPreview);

        // Initialize scenario params
        updateScenarioParams();
    </script>
</body>
</html>
