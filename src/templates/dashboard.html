<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Advanced portfolio analysis with cyberpunk aesthetics">
    <meta name="theme-color" content="#ff00ff">
    <title>Robinhood Portfolio Analysis - Dashboard</title>

    <!-- External Libraries -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-3.2.0.min.js" charset="utf-8"></script>

    <style>
        /* Robinhood-Inspired Cyberpunk Theme Variables */
        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: #12121e;
            --accent-neon: #00ffff;
            --accent-positive: #00ff88;
            --accent-negative: #ff3366;
            --accent-warning: #ffff00;
            --text-primary: #e0e0e0;
            --text-secondary: #8888aa;
            --border-color: rgba(0, 255, 255, 0.15);
            /* Legacy aliases for compatibility */
            --cyber-pink: #00ffff;
            --cyber-cyan: #00ffff;
            --cyber-green: #00ff88;
            --cyber-red: #ff3366;
            --cyber-yellow: #ffff00;
        }

        /* Base Styles */
        * {
            box-sizing: border-box;
        }

        body {
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: 'JetBrains Mono', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            line-height: 1.6;
            letter-spacing: 0.05em;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* Subtle background grid - very low opacity for atmosphere */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                linear-gradient(rgba(0, 255, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
            pointer-events: none;
            z-index: -1;
        }

        /* Typography */
        h1, h2, h3, h4, h5, h6 {
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .glow-text {
            text-shadow: 0 0 8px var(--accent-neon);
        }

        .glow-text-positive {
            text-shadow: 0 0 8px var(--accent-positive);
        }

        /* Glassmorphism Card Styles */
        .cyberpunk-card {
            background: rgba(18, 18, 30, 0.6);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            backdrop-filter: blur(12px);
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
            padding: 1.5rem;
        }

        .cyberpunk-card:hover {
            border-color: var(--accent-neon);
            box-shadow: 0 0 12px rgba(0, 255, 255, 0.15);
        }

        /* Subtle Scanlines Effect - very low opacity */
        .scanlines::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(
                transparent 50%,
                rgba(255, 255, 255, 0.015) 50%
            );
            background-size: 100% 4px;
            pointer-events: none;
            opacity: 0.6;
        }

        /* Button Styles - Clean with subtle neon */
        .cyberpunk-button {
            background: var(--accent-neon);
            border: none;
            color: #000;
            font-weight: 600;
            letter-spacing: 0.05em;
            padding: 0.875rem 1.75rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
            min-height: 48px;
        }

        .cyberpunk-button:hover {
            box-shadow: 0 0 16px rgba(0, 255, 255, 0.4);
            transform: scale(1.02);
        }

        .cyberpunk-button:active {
            transform: scale(0.98);
        }

        .cyberpunk-button-secondary {
            background: transparent;
            border: 1px solid var(--accent-neon);
            color: var(--accent-neon);
        }

        .cyberpunk-button-secondary:hover {
            background: rgba(0, 255, 255, 0.1);
            box-shadow: 0 0 12px rgba(0, 255, 255, 0.2);
        }

        /* Navigation */
        .nav-link {
            color: var(--text-secondary);
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            transition: all 0.3s ease;
            position: relative;
        }

        .nav-link:hover, .nav-link.active {
            color: var(--cyber-cyan);
            text-shadow: 0 0 10px var(--cyber-cyan);
        }

        .nav-link.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 50%;
            transform: translateX(-50%);
            width: 20px;
            height: 2px;
            background: var(--cyber-cyan);
            box-shadow: 0 0 10px var(--cyber-cyan);
        }

        /* Metric Cards */
        .metric-card {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            padding: 1rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }

        .metric-card:hover {
            border-color: var(--cyber-cyan);
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.1);
        }

        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            margin: 0.5rem 0;
        }

        .metric-positive {
            color: var(--accent-positive);
            text-shadow: 0 0 8px var(--accent-positive);
        }

        .metric-negative {
            color: var(--accent-negative);
        }

        .metric-neutral {
            color: var(--accent-neon);
            text-shadow: 0 0 8px var(--accent-neon);
        }

        /* Loading States - Neon ring spinner */
        .loading-spinner {
            display: inline-block;
            width: 24px;
            height: 24px;
            border: 2px solid rgba(0, 255, 255, 0.1);
            border-radius: 50%;
            border-top-color: var(--accent-neon);
            animation: spin 0.8s linear infinite;
            box-shadow: 0 0 8px rgba(0, 255, 255, 0.3);
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Progress Bars */
        .progress-container {
            width: 100%;
            margin: 1rem 0;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: var(--accent-neon);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 4px;
            position: relative;
            box-shadow: 0 0 8px rgba(0, 255, 255, 0.4);
        }

        .progress-text {
            text-align: center;
            margin-top: 0.5rem;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        /* Timeout/Error States */
        .loading-timeout {
            color: var(--cyber-red);
            text-shadow: 0 0 5px var(--cyber-red);
        }

        /* Connection Status Indicator */
        .connection-status {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .connection-status.online {
            color: var(--accent-positive);
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid rgba(0, 255, 136, 0.3);
        }

        .connection-status.offline {
            color: var(--accent-negative);
            background: rgba(255, 51, 102, 0.1);
            border: 1px solid rgba(255, 51, 102, 0.3);
            animation: pulse 2s infinite;
        }

        .connection-status.degraded {
            color: var(--accent-warning);
            background: rgba(255, 255, 0, 0.1);
            border: 1px solid rgba(255, 255, 0, 0.3);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Status Messages */
        #status-messages {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 1000;
            max-width: 400px;
            pointer-events: none;
        }

        .status-message {
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            border-radius: 4px;
            border: 1px solid;
            backdrop-filter: blur(10px);
            pointer-events: auto;
            animation: slideIn 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        .status-message.status-success {
            background: rgba(0, 255, 0, 0.1);
            border-color: var(--cyber-green);
            color: var(--cyber-green);
        }

        .status-message.status-error {
            background: rgba(255, 0, 64, 0.1);
            border-color: var(--cyber-red);
            color: var(--cyber-red);
        }

        .status-message.status-info {
            background: rgba(0, 255, 255, 0.1);
            border-color: var(--cyber-cyan);
            color: var(--cyber-cyan);
        }

        .status-message.status-warning {
            background: rgba(255, 255, 0, 0.1);
            border-color: var(--cyber-yellow);
            color: var(--cyber-yellow);
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }

        /* Responsive Grid */
        .portfolio-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        /* Mobile Optimizations */
        @media (max-width: 768px) {
            .portfolio-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .metric-value {
                font-size: 1.5rem;
            }

            h1 {
                font-size: 2rem;
            }
        }

        /* Accessibility */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* Focus styles for accessibility */
        button:focus, a:focus, input:focus, select:focus {
            outline: 2px solid var(--cyber-cyan);
            outline-offset: 2px;
        }

        /* High contrast mode support */
        @media (prefers-contrast: high) {
            :root {
                --text-primary: #ffffff;
                --bg-primary: #000000;
            }
        }

        /* Reduced motion support */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
    </style>
</head>
<body>
    <!-- Skip to main content for accessibility -->
    <a href="#main-content" class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 cyberpunk-button">
        Skip to main content
    </a>

    <!-- Header -->
    <header class="bg-black/50 backdrop-blur-sm border-b border-pink-500/30 sticky top-0 z-50">
        <div class="container mx-auto px-4 py-4">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="text-center md:text-left mb-4 md:mb-0">
                    <h1 class="text-3xl md:text-4xl font-bold glow-text mb-1">
                        Robinhood Portfolio Analysis
                    </h1>
                    <p class="text-lg text-gray-400">Cyberpunk Financial Intelligence</p>
                </div>

                <!-- Status Indicator -->
                <div class="flex items-center space-x-4">
                    <div id="connection-status" class="flex items-center space-x-2">
                        <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                        <span class="text-sm text-green-400">API Connected</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="bg-black/30 backdrop-blur-sm" role="navigation" aria-label="Main navigation">
        <div class="container mx-auto px-4">
            <div class="flex flex-wrap justify-center space-x-1 md:space-x-4 py-3">
                <a href="/dashboard" class="nav-link active" aria-current="page">
                    <span class="hidden sm:inline">Dashboard</span>
                    <span class="sm:hidden">üìä</span>
                </a>
                <a href="/upload" class="nav-link">
                    <span class="hidden sm:inline">Upload Data</span>
                    <span class="sm:hidden">üì§</span>
                </a>
                <a href="/analysis" class="nav-link">
                    <span class="hidden sm:inline">Analysis</span>
                    <span class="sm:hidden">üìà</span>
                </a>
                <a href="/comparison" class="nav-link">
                    <span class="hidden sm:inline">Compare</span>
                    <span class="sm:hidden">‚öñÔ∏è</span>
                </a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main id="main-content" class="container mx-auto px-4 py-8" role="main">
        <!-- Status Messages -->
        <div id="status-messages" class="mb-6" aria-live="polite" aria-atomic="true"></div>

        <!-- Portfolio Overview Section -->
        <section class="mb-8" aria-labelledby="overview-heading">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
                <h2 id="overview-heading" class="text-2xl font-bold glow-text mb-4 sm:mb-0">
                    Portfolio Overview
                </h2>

                <!-- Quick Actions -->
                <div class="flex space-x-3">
                    <button id="refresh-btn" class="cyberpunk-button-secondary px-4 py-2 text-sm" aria-label="Refresh portfolio data">
                        <span class="hidden sm:inline">Refresh</span>
                        <span class="sm:hidden">üîÑ</span>
                    </button>
                    <button id="help-btn" class="cyberpunk-button-secondary px-4 py-2 text-sm" aria-label="Show help">
                        <span class="hidden sm:inline">Help</span>
                        <span class="sm:hidden">‚ùì</span>
                    </button>
                </div>
            </div>

            <!-- Key Metrics Grid -->
            <div class="portfolio-grid" id="key-metrics" role="region" aria-labelledby="metrics-heading">
                <h3 id="metrics-heading" class="sr-only">Key Portfolio Metrics</h3>

                <!-- Loading State -->
                <div id="metrics-loading" class="col-span-full">
                    <div class="cyberpunk-card p-8 text-center">
                        <div class="scanlines"></div>
                        <div class="loading-spinner mx-auto mb-4"></div>
                        <p class="text-gray-400">Loading portfolio data...</p>
                        <div class="progress-container">
                            <div class="progress-bar">
                                <div id="portfolio-progress-fill" class="progress-fill"></div>
                            </div>
                            <div id="portfolio-progress-text" class="progress-text">Initializing...</div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Charts Section -->
        <section class="mb-8" aria-labelledby="charts-heading">
            <h2 id="charts-heading" class="text-2xl font-bold glow-text mb-6">Portfolio Visualization</h2>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Portfolio Growth Chart -->
                <div class="cyberpunk-card p-6" role="region" aria-labelledby="growth-chart-heading">
                    <div class="scanlines"></div>
                    <h3 id="growth-chart-heading" class="text-lg font-bold mb-4 glow-text">Portfolio Growth</h3>
                    <div id="growth-chart" class="h-80" role="img" aria-label="Portfolio value over time chart">
                        <div class="flex items-center justify-center h-full">
                            <div class="text-center">
                                <div class="loading-spinner mx-auto mb-4"></div>
                                <p class="text-gray-400">Loading chart...</p>
                                <div class="progress-container">
                                    <div class="progress-bar">
                                        <div id="growth-progress-fill" class="progress-fill"></div>
                                    </div>
                                    <div id="growth-progress-text" class="progress-text">Preparing...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Asset Allocation Chart -->
                <div class="cyberpunk-card p-6" role="region" aria-labelledby="allocation-chart-heading">
                    <div class="scanlines"></div>
                    <h3 id="allocation-chart-heading" class="text-lg font-bold mb-4 glow-text">Asset Allocation</h3>
                    <div id="allocation-chart" class="h-80" role="img" aria-label="Portfolio asset allocation chart">
                        <div class="flex items-center justify-center h-full">
                            <div class="text-center">
                                <div class="loading-spinner mx-auto mb-4"></div>
                                <p class="text-gray-400">Loading chart...</p>
                                <div class="progress-container">
                                    <div class="progress-bar">
                                        <div id="allocation-progress-fill" class="progress-fill"></div>
                                    </div>
                                    <div id="allocation-progress-text" class="progress-text">Preparing...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Detailed Analytics Section -->
        <section class="mb-8" aria-labelledby="analytics-heading">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
                <h2 id="analytics-heading" class="text-2xl font-bold glow-text">
                    Advanced Analytics
                </h2>

                <!-- Expand/Collapse Toggle -->
                <button id="analytics-toggle" class="cyberpunk-button-secondary px-4 py-2 text-sm" aria-expanded="false">
                    <span class="toggle-text">Show Details</span>
                    <span class="ml-2">‚ñº</span>
                </button>
            </div>

            <!-- Collapsible Analytics Content -->
            <div id="analytics-content" class="hidden space-y-6">
                <!-- Performance Metrics -->
                <div class="cyberpunk-card p-6" role="region" aria-labelledby="performance-heading">
                    <div class="scanlines"></div>
                    <h3 id="performance-heading" class="text-lg font-bold mb-4 glow-text">Performance Metrics</h3>
                    <div id="performance-metrics" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div class="text-center">
                            <div class="loading-spinner mx-auto mb-2"></div>
                            <p class="text-gray-400 text-sm">Loading...</p>
                        </div>
                    </div>
                </div>

                <!-- Risk Assessment -->
                <div class="cyberpunk-card p-6" role="region" aria-labelledby="risk-heading">
                    <div class="scanlines"></div>
                    <h3 id="risk-heading" class="text-lg font-bold mb-4 glow-text">Risk Assessment</h3>
                    <div id="risk-metrics" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div class="text-center">
                            <div class="loading-spinner mx-auto mb-2"></div>
                            <p class="text-gray-400 text-sm">Loading...</p>
                        </div>
                    </div>
                </div>

                <!-- Market Analysis -->
                <div class="cyberpunk-card p-6" role="region" aria-labelledby="market-heading">
                    <div class="scanlines"></div>
                    <h3 id="market-heading" class="text-lg font-bold mb-4 glow-text">Market Analysis</h3>
                    <div id="market-analysis" class="space-y-4">
                        <div class="text-center">
                            <div class="loading-spinner mx-auto mb-2"></div>
                            <p class="text-gray-400">Loading market analysis...</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Quick Actions -->
        <section class="text-center" aria-labelledby="actions-heading">
            <h2 id="actions-heading" class="sr-only">Quick Actions</h2>
            <div class="flex flex-wrap justify-center gap-4">
                <a href="/upload" class="cyberpunk-button" role="button">
                    Upload New Data
                </a>
                <button class="cyberpunk-button-secondary" onclick="exportData()" role="button">
                    Export Report
                </button>
                <button class="cyberpunk-button-secondary" onclick="createCustomPortfolio()" role="button">
                    Create Custom Portfolio
                </button>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="bg-black/50 backdrop-blur-sm border-t border-pink-500/30 mt-16 py-8">
        <div class="container mx-auto px-4 text-center">
            <p class="text-gray-400 text-sm">
                Robinhood Portfolio Analysis - Built with cyberpunk aesthetics and financial precision
            </p>
            <div class="mt-4 flex justify-center space-x-4 text-xs text-gray-500">
                <span>v1.0.0</span>
                <span>‚Ä¢</span>
                <span>Real-time data processing</span>
                <span>‚Ä¢</span>
                <span>Privacy-focused</span>
            </div>
        </div>
    </footer>

    <!-- Educational Modal -->
    <div id="education-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50" role="dialog" aria-modal="true" aria-labelledby="modal-title">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="cyberpunk-card max-w-3xl w-full p-6 relative">
                <div class="scanlines"></div>
                <button class="absolute top-4 right-4 text-gray-400 hover:text-white" onclick="closeModal()" aria-label="Close modal">
                    ‚úï
                </button>
                <h3 id="modal-title" class="text-xl font-bold glow-text mb-4">Understanding Your Metrics</h3>
                <div id="modal-content" class="space-y-4 max-h-96 overflow-y-auto">
                    <!-- Content will be populated by JavaScript -->
                </div>
                <div class="mt-6 flex justify-between items-center">
                    <div class="flex items-center space-x-4 text-sm text-gray-400">
                        <span id="difficulty-badge" class="px-2 py-1 rounded bg-gray-800"></span>
                        <span id="category-badge" class="px-2 py-1 rounded bg-gray-800"></span>
                    </div>
                    <div class="space-x-3">
                        <button id="prev-topic-btn" class="cyberpunk-button-secondary px-3 py-2 text-sm hidden">Previous</button>
                        <button id="next-topic-btn" class="cyberpunk-button-secondary px-3 py-2 text-sm hidden">Next</button>
                        <button class="cyberpunk-button-secondary px-4 py-2" onclick="closeModal()">Close</button>
                    </div>
                </div>
                <div id="related-topics" class="mt-4 pt-4 border-t border-gray-600">
                    <!-- Related topics will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <!-- User Onboarding Modal -->
    <div id="onboarding-modal" class="fixed inset-0 bg-black bg-opacity-75 hidden z-50" role="dialog" aria-modal="true" aria-labelledby="onboarding-title">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="cyberpunk-card max-w-2xl w-full p-8 relative">
                <div class="scanlines"></div>
                <button class="absolute top-4 right-4 text-gray-400 hover:text-white text-xl" onclick="skipOnboarding()" aria-label="Skip onboarding">
                    ‚úï
                </button>

                <!-- Progress Indicator -->
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-2">
                        <h2 id="onboarding-title" class="text-2xl font-bold glow-text">Welcome to Portfolio Analysis</h2>
                        <span id="step-indicator" class="text-sm text-gray-400">Step 1 of 5</span>
                    </div>
                    <div class="progress-bar">
                        <div id="onboarding-progress" class="progress-fill" style="width: 20%"></div>
                    </div>
                </div>

                <!-- Step Content -->
                <div id="onboarding-content" class="space-y-6">
                    <!-- Content will be populated by JavaScript -->
                </div>

                <!-- Navigation -->
                <div class="mt-8 flex justify-between items-center">
                    <button id="prev-step-btn" class="cyberpunk-button-secondary px-4 py-2" disabled>Previous</button>
                    <div class="flex space-x-2">
                        <button id="skip-onboarding-btn" class="text-gray-400 hover:text-white text-sm px-3 py-2" onclick="skipOnboarding()">
                            Skip Tour
                        </button>
                        <button id="next-step-btn" class="cyberpunk-button px-4 py-2">Next</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // Global state
        let portfolioData = null;
        let charts = {};
        let isOnline = navigator.onLine;
        let connectionStatus = 'online';
        let retryCounts = {}; // Track retry counts per endpoint
        let requestCache = {}; // Simple request cache
        let autoRefreshInterval = null;

        // Configuration
        const PROGRESS_TIMEOUT = 30000; // 30 seconds timeout per operation
        const MAX_RETRIES = 3; // Maximum retry attempts
        const RETRY_DELAY_BASE = 1000; // Base delay in ms (exponential backoff)
        const CACHE_TTL = 60000; // Cache TTL: 60 seconds
        const AUTO_REFRESH_INTERVAL = 300000; // Auto-refresh every 5 minutes

        // Network status monitoring
        function updateConnectionStatus() {
            const statusElement = document.getElementById('connection-status');
            if (!statusElement) return;

            if (isOnline && connectionStatus === 'online') {
                statusElement.className = 'connection-status online';
                statusElement.textContent = '‚óè Online';
                statusElement.title = 'Connected to server';
            } else if (!isOnline) {
                connectionStatus = 'offline';
                statusElement.className = 'connection-status offline';
                statusElement.textContent = '‚óè Offline';
                statusElement.title = 'No internet connection';
            } else if (connectionStatus === 'degraded') {
                statusElement.className = 'connection-status degraded';
                statusElement.textContent = '‚óè Degraded';
                statusElement.title = 'Some services unavailable';
            }
        }

        // Monitor online/offline status
        window.addEventListener('online', () => {
            console.log('[NETWORK] Connection restored');
            isOnline = true;
            connectionStatus = 'online';
            updateConnectionStatus();
            showStatusMessage('Connection restored', 'success');
            // Retry failed requests
            if (portfolioData === null || !portfolioData.has_data) {
                loadPortfolioData();
            }
        });

        window.addEventListener('offline', () => {
            console.log('[NETWORK] Connection lost');
            isOnline = false;
            connectionStatus = 'offline';
            updateConnectionStatus();
            showStatusMessage('No internet connection', 'error');
        });

        // Progress update functions
        function updateProgress(elementId, percentage, message) {
            const fillElement = document.getElementById(elementId + '-progress-fill');
            const textElement = document.getElementById(elementId + '-progress-text');

            if (fillElement) {
                fillElement.style.width = percentage + '%';
                fillElement.style.transition = 'width 0.3s ease';
            }
            if (textElement) {
                textElement.textContent = message;
                if (percentage >= 100) {
                    textElement.classList.add('text-green-400');
                    textElement.classList.remove('loading-timeout', 'text-yellow-400');
                } else if (percentage > 0) {
                    textElement.classList.add('text-yellow-400');
                    textElement.classList.remove('loading-timeout', 'text-green-400');
                }
            }

            console.log(`[PROGRESS] ${elementId}: ${percentage}% - ${message}`);
        }

        function updatePortfolioProgress(percentage, message) {
            updateProgress('portfolio', percentage, message);
        }

        function updateGrowthProgress(percentage, message) {
            updateProgress('growth', percentage, message);
        }

        function updateAllocationProgress(percentage, message) {
            updateProgress('allocation', percentage, message);
        }

        // Exponential backoff delay calculator
        function calculateRetryDelay(attempt) {
            return RETRY_DELAY_BASE * Math.pow(2, attempt);
        }

        // Enhanced fetch with retry, timeout, and caching
        async function fetchWithRetry(url, options = {}, timeoutMs = PROGRESS_TIMEOUT, retries = MAX_RETRIES) {
            const cacheKey = `${url}_${JSON.stringify(options)}`;
            const cached = requestCache[cacheKey];
            
            // Check cache
            if (cached && (Date.now() - cached.timestamp) < CACHE_TTL) {
                console.log(`[CACHE] Returning cached response for: ${url}`);
                return new Response(JSON.stringify(cached.data), {
                    status: 200,
                    statusText: 'OK (cached)',
                    headers: { 'Content-Type': 'application/json' }
                });
            }

            // Check if offline
            if (!isOnline) {
                throw new Error('No internet connection. Please check your network.');
            }

            let lastError;
            for (let attempt = 0; attempt <= retries; attempt++) {
                try {
                    if (attempt > 0) {
                        const delay = calculateRetryDelay(attempt - 1);
                        console.log(`[RETRY] Attempt ${attempt + 1}/${retries + 1} for ${url} after ${delay}ms`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }

                    const response = await fetchWithTimeout(url, options, timeoutMs);
                    
                    // Cache successful responses
                    if (response.ok) {
                        try {
                            const data = await response.clone().json();
                            requestCache[cacheKey] = {
                                data: data,
                                timestamp: Date.now()
                            };
                            console.log(`[CACHE] Cached response for: ${url}`);
                        } catch (e) {
                            // Not JSON, don't cache
                        }
                    }

                    // Update connection status based on response
                    if (response.ok) {
                        connectionStatus = 'online';
                        updateConnectionStatus();
                    } else if (response.status >= 500) {
                        connectionStatus = 'degraded';
                        updateConnectionStatus();
                    }

                    return response;
                } catch (error) {
                    lastError = error;
                    console.warn(`[RETRY] Attempt ${attempt + 1} failed for ${url}:`, error.message);
                    
                    // Don't retry on certain errors
                    if (error.message.includes('timeout') && attempt < retries) {
                        continue; // Retry timeouts
                    } else if (error.message.includes('No internet')) {
                        throw error; // Don't retry offline errors
                    } else if (attempt === retries) {
                        throw error; // Last attempt failed
                    }
                }
            }

            throw lastError || new Error(`Failed to fetch ${url} after ${retries + 1} attempts`);
        }

        // Timeout wrapper for fetch operations
        async function fetchWithTimeout(url, options = {}, timeoutMs = PROGRESS_TIMEOUT) {
            console.log(`[FETCH] Starting request to: ${url}`);

            const controller = new AbortController();
            const timeoutId = setTimeout(() => {
                controller.abort();
                console.error(`[TIMEOUT] Request to ${url} timed out after ${timeoutMs}ms`);
            }, timeoutMs);

            try {
                const response = await fetch(url, {
                    ...options,
                    signal: controller.signal
                });
                clearTimeout(timeoutId);
                console.log(`[FETCH] Completed request to: ${url} - Status: ${response.status}`);
                return response;
            } catch (error) {
                clearTimeout(timeoutId);
                if (error.name === 'AbortError') {
                    throw new Error(`Request timeout: ${url}`);
                }
                // Check for network errors
                if (!navigator.onLine) {
                    throw new Error('No internet connection. Please check your network.');
                }
                if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                    throw new Error('Network error. Please check your connection and try again.');
                }
                console.error(`[FETCH] Error requesting ${url}:`, error);
                throw error;
            }
        }

        // Clear cache function
        function clearCache() {
            requestCache = {};
            console.log('[CACHE] Cache cleared');
        }

        // Status message display
        function showStatusMessage(message, type = 'info', duration = 3000) {
            const statusContainer = document.getElementById('status-messages');
            if (!statusContainer) return;

            const messageEl = document.createElement('div');
            messageEl.className = `status-message status-${type}`;
            messageEl.textContent = message;
            messageEl.setAttribute('role', 'alert');
            
            statusContainer.appendChild(messageEl);
            
            // Auto-remove after duration
            setTimeout(() => {
                messageEl.style.opacity = '0';
                messageEl.style.transform = 'translateY(-10px)';
                setTimeout(() => messageEl.remove(), 300);
            }, duration);
        }

        // Data validation and sanitization
        function validatePortfolioData(data) {
            if (!data || typeof data !== 'object') {
                return {
                    valid: false,
                    sanitized: {
                        has_data: false,
                        transaction_count: 0,
                        unique_tickers: 0,
                        current_holdings_count: 0,
                        holdings: {},
                        performance: { total_return: 0, total_value: 0, start_value: 0, start_date: "", end_date: "" },
                        performance_metrics: {},
                        risk_assessment: {},
                        advanced_analytics: {}
                    }
                };
            }

            const sanitized = {
                has_data: Boolean(data.has_data),
                transaction_count: Math.max(0, parseInt(data.transaction_count) || 0),
                unique_tickers: Math.max(0, parseInt(data.unique_tickers) || 0),
                current_holdings_count: Math.max(0, parseInt(data.current_holdings_count) || 0),
                holdings: (data.holdings && typeof data.holdings === 'object') ? data.holdings : {},
                performance: {
                    total_return: parseFloat(data.performance?.total_return) || 0,
                    total_value: Math.max(0, parseFloat(data.performance?.total_value) || 0),
                    start_value: Math.max(0, parseFloat(data.performance?.start_value) || 0),
                    start_date: String(data.performance?.start_date || ''),
                    end_date: String(data.performance?.end_date || '')
                },
                performance_metrics: (data.performance_metrics && typeof data.performance_metrics === 'object') ? data.performance_metrics : {},
                risk_assessment: (data.risk_assessment && typeof data.risk_assessment === 'object') ? data.risk_assessment : {},
                advanced_analytics: (data.advanced_analytics && typeof data.advanced_analytics === 'object') ? data.advanced_analytics : {}
            };

            // Validate numeric values are finite
            if (!isFinite(sanitized.performance.total_return)) sanitized.performance.total_return = 0;
            if (!isFinite(sanitized.performance.total_value)) sanitized.performance.total_value = 0;
            if (!isFinite(sanitized.performance.start_value)) sanitized.performance.start_value = 0;

            return {
                valid: true,
                sanitized: sanitized
            };
        }

        function validateChartData(data) {
            if (!data || !Array.isArray(data)) {
                return { valid: false, sanitized: [] };
            }

            const sanitized = data.filter(item => {
                if (!item || typeof item !== 'object') return false;
                // Fix: Check for date existence, but allow portfolio_value to be 0
                if (!item.date || item.portfolio_value === undefined || item.portfolio_value === null) return false;
                const value = parseFloat(item.portfolio_value);
                // Allow zero values - they're valid data points
                return isFinite(value) && value >= 0;
            }).map(item => ({
                date: String(item.date),
                portfolio_value: Math.max(0, parseFloat(item.portfolio_value)),
                holdings: (item.holdings && typeof item.holdings === 'object') ? item.holdings : {}
            }));

            // Consider data valid even if all values are zero (shows the problem)
            return {
                valid: sanitized.length > 0,
                sanitized: sanitized,
                allZero: sanitized.length > 0 && sanitized.every(item => item.portfolio_value === 0)
            };
        }

        // DOM Content Loaded
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        // Initialize the application
        async function initializeApp() {
            setupEventListeners();
            updateConnectionStatus(); // Initialize connection status
            
            // Load initial data
            await loadPortfolioData();

            // Check URL hash for direct navigation
            if (window.location.hash === '#analytics') {
                toggleAnalytics(true);
            }

            // Start auto-refresh
            startAutoRefresh();
        }

        // Auto-refresh functionality
        function startAutoRefresh() {
            // Clear any existing interval
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }

            // Only auto-refresh if online and user is active
            autoRefreshInterval = setInterval(() => {
                if (isOnline && !document.hidden && portfolioData && portfolioData.has_data) {
                    console.log('[AUTO-REFRESH] Refreshing data...');
                    loadPortfolioData().catch(error => {
                        console.error('[AUTO-REFRESH] Error:', error);
                    });
                }
            }, AUTO_REFRESH_INTERVAL);

            // Refresh when page becomes visible
            document.addEventListener('visibilitychange', () => {
                if (!document.hidden && isOnline) {
                    console.log('[VISIBILITY] Page visible, refreshing data...');
                    loadPortfolioData().catch(error => {
                        console.error('[VISIBILITY] Error:', error);
                    });
                }
            });
        }

        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Refresh button
            const refreshBtn = document.getElementById('refresh-btn');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', async () => {
                    clearCache(); // Clear cache on manual refresh
                    showStatusMessage('Refreshing data...', 'info');
                    try {
                        await loadPortfolioData();
                        showStatusMessage('Data refreshed successfully', 'success');
                    } catch (error) {
                        showStatusMessage('Failed to refresh data', 'error');
                    }
                });
            }

            // Help button
            document.getElementById('help-btn').addEventListener('click', showHelpModal);

            // Analytics toggle
            document.getElementById('analytics-toggle').addEventListener('click', () => {
                const content = document.getElementById('analytics-content');
                const button = document.getElementById('analytics-toggle');
                const isExpanded = button.getAttribute('aria-expanded') === 'true';

                toggleAnalytics(!isExpanded);
            });

            // Keyboard navigation
            document.addEventListener('keydown', handleKeyboardNavigation);
        }

        // Handle keyboard navigation
        function handleKeyboardNavigation(event) {
            // Escape key closes modals
            if (event.key === 'Escape') {
                closeModal();
            }

            // Ctrl/Cmd + R refreshes data
            if ((event.ctrlKey || event.metaKey) && event.key === 'r') {
                event.preventDefault();
                loadPortfolioData();
            }
        }

        // Load portfolio data
        async function loadPortfolioData() {
            try {
                console.log('[LOAD] Starting portfolio data load');
                updatePortfolioProgress(0, 'Initializing...');
                showLoadingState();

                updatePortfolioProgress(25, 'Fetching overview data...');
                const response = await fetchWithRetry('/api/portfolio-overview');
                
                if (!response.ok) {
                    console.warn(`[LOAD] Portfolio overview returned ${response.status}, but continuing with partial data`);
                    // Initialize with empty structure instead of throwing
                    portfolioData = {
                        has_data: false,
                        transaction_count: 0,
                        unique_tickers: 0,
                        current_holdings_count: 0,
                        holdings: {},
                        performance: {
                            total_return: 0,
                            total_value: 0,
                            start_value: 0,
                            start_date: "",
                            end_date: ""
                        },
                        performance_metrics: {},
                        risk_assessment: {},
                        advanced_analytics: {}
                    };
                } else {
                    updatePortfolioProgress(50, 'Processing data...');
                    const rawData = await response.json();
                    
                    // Validate and sanitize data
                    const validation = validatePortfolioData(rawData);
                    if (!validation.valid) {
                        console.warn('[LOAD] Invalid portfolio data structure, using sanitized version');
                        showStatusMessage('Data validation warning', 'warning');
                    }
                    portfolioData = validation.sanitized;
                    console.log('[LOAD] Portfolio data received and validated:', portfolioData);
                }

                updatePortfolioProgress(75, 'Updating interface...');
                updateUI();

                updatePortfolioProgress(100, 'Complete!');

            } catch (error) {
                console.error('[LOAD] Error loading portfolio data:', error);
                updatePortfolioProgress(0, 'Failed - ' + error.message);

                // Initialize with empty structure on error
                portfolioData = {
                    has_data: false,
                    transaction_count: 0,
                    unique_tickers: 0,
                    current_holdings_count: 0,
                    holdings: {},
                    performance: {
                        total_return: 0,
                        total_value: 0,
                        start_value: 0,
                        start_date: "",
                        end_date: ""
                    },
                    performance_metrics: {},
                    risk_assessment: {},
                    advanced_analytics: {}
                };

                // Add timeout styling if it's a timeout error
                const textElement = document.getElementById('portfolio-progress-text');
                if (textElement && error.message.includes('timeout')) {
                    textElement.classList.add('loading-timeout');
                }

                showErrorState(error.message);
            } finally {
                // Always try to load charts, even if portfolio-overview failed
                console.log('[LOAD] Attempting to load charts independently');
                try {
                    await updateCharts();
                } catch (chartError) {
                    console.error('[LOAD] Error loading charts:', chartError);
                    // Charts will show error messages themselves
                }

                // Hide loading state after a brief delay to show completion
                setTimeout(() => {
                    hideLoadingState();
                }, 1000);
            }
        }

        // Show loading state
        function showLoadingState() {
            const metricsContainer = document.getElementById('key-metrics');
            if (metricsContainer) {
                metricsContainer.innerHTML = `
                    <div class="col-span-full">
                        <div class="cyberpunk-card p-8 text-center">
                            <div class="scanlines"></div>
                            <div class="loading-spinner mx-auto mb-4"></div>
                            <p class="text-gray-400">Loading portfolio data...</p>
                        </div>
                    </div>
                `;
            }
        }

        // Hide loading state
        function hideLoadingState() {
            const loadingElement = document.getElementById('metrics-loading');
            if (loadingElement) {
                loadingElement.style.display = 'none';
            }
        }

        // Show error state with helpful guidance
        function showErrorState(message) {
            const metricsContainer = document.getElementById('key-metrics');
            if (metricsContainer) {
                // Determine if this is a "no data" error or a real error
                const isNoDataError = message.includes('No transactions') || 
                                     message.includes('no data') || 
                                     (portfolioData && !portfolioData.has_data);
                
                if (isNoDataError) {
                    metricsContainer.innerHTML = `
                        <div class="col-span-full">
                            <div class="cyberpunk-card p-8 text-center">
                                <div class="scanlines"></div>
                                <h3 class="text-xl font-bold glow-text mb-4">Welcome to Portfolio Analysis</h3>
                                <p class="text-gray-400 mb-6">No transaction data found. Upload your Robinhood transaction CSV file to get started.</p>
                                <a href="/upload" class="cyberpunk-button inline-block">
                                    Upload CSV File
                                </a>
                            </div>
                        </div>
                    `;
                } else {
                    metricsContainer.innerHTML = `
                        <div class="col-span-full">
                            <div class="cyberpunk-card p-8 text-center">
                                <div class="scanlines"></div>
                                <p class="text-yellow-400 mb-2">‚ö†Ô∏è Partial Data Available</p>
                                <p class="text-gray-400 text-sm mb-4">Some portfolio metrics are unavailable, but charts may still load below.</p>
                                <p class="text-gray-500 text-xs mb-4">Error: ${message}</p>
                                <button class="cyberpunk-button-secondary px-4 py-2 mr-2" onclick="loadPortfolioData()">
                                    Retry
                                </button>
                                <a href="/upload" class="cyberpunk-button-secondary px-4 py-2 inline-block">
                                    Upload Data
                                </a>
                            </div>
                        </div>
                    `;
                }
            }
        }

        // Update UI with portfolio data
        function updateUI() {
            if (!portfolioData) return;

            updateKeyMetrics();
            // Don't call updateCharts() here - it's called in finally block for reliability
            // updateCharts(); // Removed to prevent duplicate loading
            updateConnectionStatus();

            if (document.getElementById('analytics-content').classList.contains('hidden') === false) {
                updateAnalytics();
            }
        }

        // Update key metrics with graceful degradation
        function updateKeyMetrics() {
            const container = document.getElementById('key-metrics');

            if (!portfolioData) {
                console.warn('[METRICS] No portfolio data available');
                return;
            }

            // Check if we have any data at all
            const hasAnyData = portfolioData.has_data || 
                              (portfolioData.transaction_count && portfolioData.transaction_count > 0);

            if (!hasAnyData) {
                container.innerHTML = `
                    <div class="col-span-full">
                        <div class="cyberpunk-card p-8 text-center">
                            <div class="scanlines"></div>
                            <h3 class="text-xl font-bold glow-text mb-4">Welcome to Portfolio Analysis</h3>
                            <p class="text-gray-400 mb-6">Upload your Robinhood transaction data to get started</p>
                            <a href="/upload" class="cyberpunk-button inline-block">
                                Upload CSV File
                            </a>
                        </div>
                    </div>
                `;
                return;
            }

            const perf = portfolioData.performance || {};
            const totalReturn = perf.total_return || 0;
            
            // Check if we have partial data (some metrics missing)
            const hasPartialData = !portfolioData.has_data || 
                                  !portfolioData.performance_metrics || 
                                  Object.keys(portfolioData.performance_metrics || {}).length === 0;
            
            // Show warning if partial data
            let partialDataWarning = '';
            if (hasPartialData && portfolioData.transaction_count > 0) {
                partialDataWarning = `
                    <div class="col-span-full mb-4">
                        <div class="cyberpunk-card p-4 border-yellow-400 border-opacity-50">
                            <div class="scanlines"></div>
                            <p class="text-yellow-400 text-sm">
                                ‚ö†Ô∏è Some advanced metrics are unavailable. Basic data is shown below.
                            </p>
                        </div>
                    </div>
                `;
            }

            container.innerHTML = partialDataWarning + `
                <div class="metric-card">
                    <div class="scanlines"></div>
                    <h4 class="text-sm text-gray-400 mb-2">Total Transactions</h4>
                    <div class="metric-value glow-text">${portfolioData.transaction_count || 0}</div>
                    <button class="text-xs text-cyan-400 hover:text-cyan-300 mt-2" onclick="showEducationalModal('transactions')">
                        Learn more
                    </button>
                </div>

                <div class="metric-card">
                    <div class="scanlines"></div>
                    <h4 class="text-sm text-gray-400 mb-2">Unique Assets</h4>
                    <div class="metric-value glow-text">${portfolioData.unique_tickers || 0}</div>
                    <button class="text-xs text-cyan-400 hover:text-cyan-300 mt-2" onclick="showEducationalModal('assets')">
                        Learn more
                    </button>
                </div>

                <div class="metric-card">
                    <div class="scanlines"></div>
                    <h4 class="text-sm text-gray-400 mb-2">Current Holdings</h4>
                    <div class="metric-value glow-text">${portfolioData.current_holdings_count || 0}</div>
                    <button class="text-xs text-cyan-400 hover:text-cyan-300 mt-2" onclick="showEducationalModal('holdings')">
                        Learn more
                    </button>
                </div>

                <div class="metric-card">
                    <div class="scanlines"></div>
                    <h4 class="text-sm text-gray-400 mb-2">Total Return</h4>
                    <div class="metric-value ${totalReturn >= 0 ? 'metric-positive' : 'metric-negative'}">
                        ${totalReturn.toFixed(2)}%
                    </div>
                    <button class="text-xs text-cyan-400 hover:text-cyan-300 mt-2" onclick="showEducationalModal('returns')">
                        Learn more
                    </button>
                </div>
            `;
        }

        // Update charts - works independently of portfolio-overview
        async function updateCharts() {
            console.log('[CHARTS] Starting chart updates');
            updateGrowthProgress(0, 'Starting...');
            updateAllocationProgress(0, 'Starting...');

            // Portfolio growth chart - fetch independently
            try {
                updateGrowthProgress(25, 'Fetching history data...');
                const growthData = await fetchWithRetry('/api/portfolio-history');
                
                if (!growthData.ok) {
                    console.warn(`[CHARTS] History API returned ${growthData.status}`);
                    updateGrowthProgress(0, `History unavailable (${growthData.status})`);
                    const container = document.getElementById('growth-chart');
                    if (container) {
                        container.innerHTML = `
                            <div class="text-center p-8 text-gray-400">
                                <p>Portfolio history data is currently unavailable.</p>
                                <p class="text-sm mt-2">Please try refreshing the page.</p>
                            </div>
                        `;
                    }
                } else {
                    const growthJson = await growthData.json();
                    console.log('[CHARTS] History data received:', growthJson);

                    updateGrowthProgress(50, 'Processing data...');
                    
                    // Validate chart data
                    const chartData = growthJson?.history || [];
                    const validation = validateChartData(chartData);
                    
                    if (validation.valid && validation.sanitized.length > 0) {
                        // Check if all values are zero (indicates missing price data)
                        if (validation.allZero) {
                            console.warn('[CHARTS] All portfolio values are zero - likely missing stock price data');
                            updateGrowthProgress(0, 'No price data');
                            const container = document.getElementById('growth-chart');
                            if (container) {
                                container.innerHTML = `
                                    <div class="text-center p-8 text-yellow-400">
                                        <p class="font-bold mb-2">‚ö†Ô∏è Stock Price Data Unavailable</p>
                                        <p class="text-sm text-gray-400 mb-4">
                                            Portfolio history data points exist, but all values are zero.
                                            This usually means stock price data is missing from the database.
                                        </p>
                                        <p class="text-xs text-gray-500">
                                            Tickers in your portfolio may need price data to be fetched.
                                            Check server logs for missing ticker information.
                                        </p>
                                    </div>
                                `;
                            }
                        } else {
                            updateGrowthProgress(75, 'Rendering chart...');
                            createGrowthChart(validation.sanitized);
                            updateGrowthProgress(100, 'Complete!');
                        }
                    } else {
                        updateGrowthProgress(0, 'No history data');
                        console.warn('[CHARTS] No history data available');
                        const container = document.getElementById('growth-chart');
                        if (container) {
                            container.innerHTML = `
                                <div class="text-center p-8 text-gray-400">
                                    <p>No portfolio history data available.</p>
                                    <p class="text-sm mt-2">Upload transaction data to see portfolio growth over time.</p>
                                </div>
                            `;
                        }
                    }
                }
            } catch (error) {
                console.error('[CHARTS] Error updating growth chart:', error);
                updateGrowthProgress(0, 'Failed: ' + error.message);
                const container = document.getElementById('growth-chart');
                if (container) {
                    container.innerHTML = `
                        <div class="text-center p-8 text-red-400">
                            <p>Error loading growth chart: ${error.message}</p>
                            <p class="text-sm mt-2 text-gray-400">Please try refreshing the page.</p>
                        </div>
                    `;
                }
                // Add timeout styling for timeout errors
                if (error.message.includes('timeout')) {
                    document.getElementById('growth-progress-text')?.classList.add('loading-timeout');
                }
            }

            // Asset allocation chart - fetch independently
            try {
                updateAllocationProgress(25, 'Fetching analytics...');
                
                // Try to get analytics from portfolioData first, otherwise fetch directly
                let analyticsData = null;
                if (portfolioData && portfolioData.advanced_analytics && portfolioData.advanced_analytics.position_weights) {
                    console.log('[CHARTS] Using analytics from portfolio data');
                    analyticsData = portfolioData.advanced_analytics;
                } else {
                    console.log('[CHARTS] Fetching advanced analytics data directly');
                    const response = await fetchWithRetry('/api/advanced-analytics');
                    if (response.ok) {
                        analyticsData = await response.json();
                        // Cache it in portfolioData if available
                        if (portfolioData) {
                            portfolioData.advanced_analytics = analyticsData;
                        }
                        console.log('[CHARTS] Analytics data received:', analyticsData);
                    } else {
                        console.warn(`[CHARTS] Analytics API returned ${response.status}`);
                        updateAllocationProgress(0, `Analytics unavailable (${response.status})`);
                        const container = document.getElementById('allocation-chart');
                        if (container) {
                            container.innerHTML = `
                                <div class="text-center p-8 text-gray-400">
                                    <p>Asset allocation data is currently unavailable.</p>
                                    <p class="text-sm mt-2">Please try refreshing the page.</p>
                                </div>
                            `;
                        }
                        return; // Exit early if analytics fetch failed
                    }
                }

                updateAllocationProgress(50, 'Processing weights...');
                if (analyticsData && analyticsData.position_weights && Object.keys(analyticsData.position_weights).length > 0) {
                    updateAllocationProgress(75, 'Rendering chart...');
                    createAllocationChart(analyticsData.position_weights);
                    updateAllocationProgress(100, 'Complete!');
                } else {
                    updateAllocationProgress(0, 'No position data');
                    console.warn('[CHARTS] No position weights available');
                    const container = document.getElementById('allocation-chart');
                    if (container) {
                        container.innerHTML = `
                            <div class="text-center p-8 text-gray-400">
                                <p>No asset allocation data available.</p>
                                <p class="text-sm mt-2">Upload transaction data to see your asset allocation.</p>
                            </div>
                        `;
                    }
                }
            } catch (error) {
                console.error('[CHARTS] Error updating allocation chart:', error);
                updateAllocationProgress(0, 'Failed: ' + error.message);
                const container = document.getElementById('allocation-chart');
                if (container) {
                    container.innerHTML = `
                        <div class="text-center p-8 text-red-400">
                            <p>Error loading allocation chart: ${error.message}</p>
                            <p class="text-sm mt-2 text-gray-400">Please try refreshing the page.</p>
                        </div>
                    `;
                }
                // Add timeout styling for timeout errors
                if (error.message.includes('timeout')) {
                    document.getElementById('allocation-progress-text')?.classList.add('loading-timeout');
                }
            }
        }

        // Create enhanced portfolio growth chart
        function createGrowthChart(historyData) {
            const container = document.getElementById('growth-chart');

            if (!historyData || historyData.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-400">No historical data available</p>';
                return;
            }

            // Prepare data for multiple traces
            const dates = historyData.map(d => d.date);
            const values = historyData.map(d => d.portfolio_value);

            // Calculate moving averages
            const ma20 = calculateMovingAverage(values, 20);
            const ma50 = calculateMovingAverage(values, 50);

            // Create traces
            const traces = [
                {
                    x: dates,
                    y: values,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Portfolio Value',
                    line: {color: '#00ffff', width: 2},
                    fill: 'tozeroy',
                    fillcolor: 'rgba(0, 255, 255, 0.1)',
                    hovertemplate: 'Date: %{x}<br>Value: $%{y:,.2f}<extra></extra>'
                },
                {
                    x: dates.slice(19), // Offset for 20-day MA
                    y: ma20,
                    type: 'scatter',
                    mode: 'lines',
                    name: '20-Day MA',
                    line: {color: '#ff00ff', width: 1, dash: 'dot'},
                    hovertemplate: '20-Day MA: $%{y:,.2f}<extra></extra>'
                },
                {
                    x: dates.slice(49), // Offset for 50-day MA
                    y: ma50,
                    type: 'scatter',
                    mode: 'lines',
                    name: '50-Day MA',
                    line: {color: '#00ff00', width: 1, dash: 'dash'},
                    hovertemplate: '50-Day MA: $%{y:,.2f}<extra></extra>'
                }
            ];

            const layout = {
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                font: {color: '#e0e0e0'},
                title: {
                    text: 'Portfolio Growth Over Time',
                    font: {color: '#00ffff', size: 16}
                },
                xaxis: {
                    title: 'Date',
                    gridcolor: 'rgba(255,255,255,0.1)',
                    type: 'date'
                },
                yaxis: {
                    title: 'Portfolio Value ($)',
                    gridcolor: 'rgba(255,255,255,0.1)',
                    tickformat: ',.0f'
                },
                margin: {t: 50, r: 10, b: 40, l: 60},
                showlegend: true,
                legend: {
                    x: 0,
                    y: 1,
                    bgcolor: 'rgba(0,0,0,0.5)',
                    bordercolor: 'rgba(255,255,255,0.2)',
                    borderwidth: 1
                },
                hovermode: 'x unified'
            };

            const config = {
                responsive: true,
                displayModeBar: true,
                modeBarButtonsToRemove: ['pan2d', 'lasso2d', 'select2d'],
                displaylogo: false
            };

            Plotly.newPlot('growth-chart', traces, layout, config);
        }

        // Create enhanced asset allocation chart
        function createAllocationChart(weights) {
            const container = document.getElementById('allocation-chart');

            if (!weights || Object.keys(weights).length === 0) {
                container.innerHTML = '<p class="text-center text-gray-400">No allocation data available</p>';
                return;
            }

            // Sort by weight descending for better visualization
            const sortedEntries = Object.entries(weights)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 10); // Show top 10 holdings

            const labels = sortedEntries.map(([ticker]) => ticker);
            const values = sortedEntries.map(([,weight]) => weight);

            // Create donut chart
            const data = [{
                labels: labels,
                values: values,
                type: 'pie',
                hole: 0.4, // Donut hole
                textinfo: 'label+percent',
                textposition: 'inside',
                insidetextorientation: 'radial',
                marker: {
                    colors: [
                        '#ff00ff', '#00ffff', '#00ff00', '#ffff00',
                        '#ff0040', '#8000ff', '#ff8000', '#00ff80',
                        '#ff0080', '#80ff00'
                    ],
                    line: {
                        color: 'rgba(255,255,255,0.2)',
                        width: 1
                    }
                },
                hovertemplate: '<b>%{label}</b><br>%{percent}<br>$%{value:.1f}<extra></extra>',
                texttemplate: '%{label}<br>%{percent}',
                textfont: {
                    size: 12,
                    color: '#000000'
                }
            }];

            const layout = {
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                font: {color: '#e0e0e0'},
                title: {
                    text: 'Asset Allocation',
                    font: {color: '#00ffff', size: 16}
                },
                showlegend: true,
                legend: {
                    orientation: 'h',
                    y: -0.2,
                    x: 0.5,
                    xanchor: 'center',
                    bgcolor: 'rgba(0,0,0,0.5)',
                    bordercolor: 'rgba(255,255,255,0.2)',
                    borderwidth: 1,
                    font: {size: 10}
                },
                margin: {t: 50, r: 10, b: 120, l: 10},
                annotations: [{
                    text: 'Click segments<br>for details',
                    showarrow: false,
                    x: 0.5,
                    y: 0.5,
                    xref: 'paper',
                    yref: 'paper',
                    font: {size: 12, color: '#888888'}
                }]
            };

            const config = {
                responsive: true,
                displayModeBar: true,
                modeBarButtonsToRemove: ['pan2d', 'lasso2d', 'select2d'],
                displaylogo: false
            };

            Plotly.newPlot('allocation-chart', data, layout, config);

            // Add click handler for detailed view
            document.getElementById('allocation-chart').on('plotly_click', function(data) {
                if (data.points && data.points[0]) {
                    const point = data.points[0];
                    const ticker = point.label;
                    const percentage = point.percent;
                    const value = point.value;

                    showEducationalModal('allocation-detail', {
                        ticker: ticker,
                        percentage: percentage,
                        value: value
                    });
                }
            });
        }

        // Fetch portfolio history
        async function fetchPortfolioHistory() {
            try {
                const response = await fetch('/api/portfolio-history');
                if (response.ok) {
                    return await response.json();
                }
            } catch (error) {
                console.error('Error fetching portfolio history:', error);
            }
            return null;
        }

        // Update analytics section
        async function updateAnalytics() {
            try {
                if (!portfolioData.advanced_analytics) {
                    // Fetch advanced analytics if not already loaded
                    const response = await fetch('/api/advanced-analytics');
                    if (response.ok) {
                        const analytics = await response.json();
                        portfolioData.advanced_analytics = analytics;
                    }
                }

                if (portfolioData.advanced_analytics) {
                    updatePerformanceMetrics();
                    updateRiskMetrics();
                    updateMarketAnalysis();
                }

            } catch (error) {
                console.error('Error updating analytics:', error);
            }
        }

        // Update performance metrics
        function updatePerformanceMetrics() {
            const container = document.getElementById('performance-metrics');
            const perf = portfolioData.performance_metrics || {};

            container.innerHTML = `
                <div class="text-center">
                    <div class="metric-value metric-neutral">${(perf.cagr || 0).toFixed(2)}%</div>
                    <div class="text-sm text-gray-400">CAGR</div>
                </div>
                <div class="text-center">
                    <div class="metric-value metric-neutral">${(perf.volatility || 0).toFixed(2)}%</div>
                    <div class="text-sm text-gray-400">Volatility</div>
                </div>
                <div class="text-center">
                    <div class="metric-value ${(perf.total_return || 0) >= 0 ? 'metric-positive' : 'metric-negative'}">
                        ${(perf.total_return || 0).toFixed(2)}%
                    </div>
                    <div class="text-sm text-gray-400">Total Return</div>
                </div>
                <div class="text-center">
                    <div class="metric-value metric-negative">${(perf.max_drawdown || 0).toFixed(2)}%</div>
                    <div class="text-sm text-gray-400">Max Drawdown</div>
                </div>
            `;
        }

        // Update risk metrics
        function updateRiskMetrics() {
            const container = document.getElementById('risk-metrics');
            const risk = portfolioData.advanced_analytics?.benchmarking || {};

            container.innerHTML = `
                <div class="text-center">
                    <div class="metric-value metric-neutral">${(risk.tracking_error || 0).toFixed(2)}%</div>
                    <div class="text-sm text-gray-400">Tracking Error</div>
                </div>
                <div class="text-center">
                    <div class="metric-value metric-neutral">${(risk.information_ratio || 0).toFixed(2)}</div>
                    <div class="text-sm text-gray-400">Information Ratio</div>
                </div>
                <div class="text-center">
                    <div class="metric-value metric-neutral">${(portfolioData.risk_assessment?.value_at_risk?.var_95 || 0).toFixed(2)}%</div>
                    <div class="text-sm text-gray-400">VaR (95%)</div>
                </div>
                <div class="text-center">
                    <div class="metric-value ${(portfolioData.performance?.sharpe_ratio || 0) >= 1 ? 'metric-positive' : 'metric-neutral'}">
                        ${(portfolioData.risk_assessment?.sharpe_ratio || 0).toFixed(2)}
                    </div>
                    <div class="text-sm text-gray-400">Sharpe Ratio</div>
                </div>
            `;
        }

        // Update market analysis
        function updateMarketAnalysis() {
            const container = document.getElementById('market-analysis');
            const market = portfolioData.advanced_analytics?.market_conditions?.market_conditions || {};

            container.innerHTML = `
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <div class="text-center">
                        <div class="metric-value metric-neutral">${market.bull_market_days || 0}</div>
                        <div class="text-sm text-gray-400">Bull Market Days</div>
                    </div>
                    <div class="text-center">
                        <div class="metric-value metric-neutral">${market.bear_market_days || 0}</div>
                        <div class="text-sm text-gray-400">Bear Market Days</div>
                    </div>
                    <div class="text-center">
                        <div class="metric-value metric-neutral">${market.neutral_market_days || 0}</div>
                        <div class="text-sm text-gray-400">Neutral Days</div>
                    </div>
                </div>
            `;
        }

        // Toggle analytics section
        function toggleAnalytics(show) {
            const content = document.getElementById('analytics-content');
            const button = document.getElementById('analytics-toggle');
            const toggleText = button.querySelector('.toggle-text');

            if (show) {
                content.classList.remove('hidden');
                button.setAttribute('aria-expanded', 'true');
                toggleText.textContent = 'Hide Details';
                button.querySelector('span:last-child').textContent = '‚ñ≤';

                // Load analytics data
                updateAnalytics();
            } else {
                content.classList.add('hidden');
                button.setAttribute('aria-expanded', 'false');
                toggleText.textContent = 'Show Details';
                button.querySelector('span:last-child').textContent = '‚ñº';
            }
        }

        // Show educational modal
        function showEducationalModal(topic, extraData = null) {
            const modal = document.getElementById('education-modal');
            const content = document.getElementById('modal-content');
            const modalTitle = document.getElementById('modal-title');
            const difficultyBadge = document.getElementById('difficulty-badge');
            const categoryBadge = document.getElementById('category-badge');
            const prevBtn = document.getElementById('prev-topic-btn');
            const nextBtn = document.getElementById('next-topic-btn');
            const relatedContainer = document.getElementById('related-topics');

            // Comprehensive Educational Content Database
            const educationalContent = {
                transactions: {
                    title: "Understanding Transactions",
                    difficulty: "Beginner",
                    category: "Portfolio Basics",
                    content: `
                        <div class="space-y-4">
                            <p class="text-lg text-cyan-300">What are Transactions?</p>
                            <p>Transactions represent every financial action you've taken in your investment account. Each transaction has a specific purpose and impact on your portfolio.</p>

                            <div class="bg-gray-800/50 p-4 rounded border-l-4 border-cyan-500">
                                <h4 class="font-bold text-cyan-400 mb-2">Common Transaction Types:</h4>
                                <ul class="space-y-2">
                                    <li><strong class="text-green-400">BUY:</strong> Purchasing securities - increases your position</li>
                                    <li><strong class="text-red-400">SELL:</strong> Selling securities - decreases your position</li>
                                    <li><strong class="text-yellow-400">DIVIDEND:</strong> Income paid by companies you own</li>
                                    <li><strong class="text-purple-400">TRANSFER:</strong> Money moved in or out of your account</li>
                                </ul>
                            </div>

                            <div class="bg-yellow-900/20 p-4 rounded border-l-4 border-yellow-500">
                                <h4 class="font-bold text-yellow-400 mb-2">üí° Key Insight:</h4>
                                <p>Understanding transaction history helps you analyze your investment behavior and timing decisions.</p>
                            </div>
                        </div>
                    `,
                    related: ["assets", "holdings", "returns"]
                },

                assets: {
                    title: "Unique Assets & Diversification",
                    difficulty: "Beginner",
                    category: "Risk Management",
                    content: `
                        <div class="space-y-4">
                            <p class="text-lg text-cyan-300">What are Unique Assets?</p>
                            <p>This metric shows how many different securities you've owned throughout your investment journey. It's a measure of your diversification breadth over time.</p>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="bg-red-900/20 p-4 rounded border border-red-500/30">
                                    <h4 class="font-bold text-red-400 mb-2">Too Few Assets (High Risk):</h4>
                                    <ul class="text-sm space-y-1">
                                        <li>‚Ä¢ Single stock concentration</li>
                                        <li>‚Ä¢ Company-specific risk</li>
                                        <li>‚Ä¢ Limited diversification</li>
                                    </ul>
                                </div>
                                <div class="bg-green-900/20 p-4 rounded border border-green-500/30">
                                    <h4 class="font-bold text-green-400 mb-2">Balanced Assets (Lower Risk):</h4>
                                    <ul class="text-sm space-y-1">
                                        <li>‚Ä¢ Broad sector coverage</li>
                                        <li>‚Ä¢ Geographic diversity</li>
                                        <li>‚Ä¢ Risk distribution</li>
                                    </ul>
                                </div>
                            </div>

                            <div class="bg-blue-900/20 p-4 rounded border-l-4 border-blue-500">
                                <h4 class="font-bold text-blue-400 mb-2">üìä Diversification Benefits:</h4>
                                <ul class="space-y-1">
                                    <li>‚Ä¢ Reduces company-specific risk</li>
                                    <li>‚Ä¢ Smooths portfolio volatility</li>
                                    <li>‚Ä¢ Protects against single failures</li>
                                    <li>‚Ä¢ May improve risk-adjusted returns</li>
                                </ul>
                            </div>
                        </div>
                    `,
                    related: ["holdings", "risk", "allocation"]
                },

                holdings: {
                    title: "Current Holdings Analysis",
                    difficulty: "Beginner",
                    category: "Portfolio Basics",
                    content: `
                        <div class="space-y-4">
                            <p class="text-lg text-cyan-300">What are Current Holdings?</p>
                            <p>This shows the number of securities you actively own right now. Unlike "Unique Assets," this only counts positions you still hold, not ones you've sold.</p>

                            <div class="bg-gray-800/50 p-4 rounded">
                                <h4 class="font-bold text-gray-300 mb-2">Understanding the Difference:</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                    <div>
                                        <strong class="text-cyan-400">Current Holdings:</strong>
                                        <ul class="mt-1 space-y-1">
                                            <li>‚Ä¢ Active positions today</li>
                                            <li>‚Ä¢ Contribute to current performance</li>
                                            <li>‚Ä¢ Require ongoing monitoring</li>
                                        </ul>
                                    </div>
                                    <div>
                                        <strong class="text-purple-400">Unique Assets (Lifetime):</strong>
                                        <ul class="mt-1 space-y-1">
                                            <li>‚Ä¢ All securities ever owned</li>
                                            <li>‚Ä¢ Shows diversification history</li>
                                            <li>‚Ä¢ Includes sold positions</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>

                            <div class="bg-yellow-900/20 p-4 rounded border-l-4 border-yellow-500">
                                <h4 class="font-bold text-yellow-400 mb-2">‚ö†Ô∏è Concentration Risk:</h4>
                                <p>If you have very few current holdings, you may have significant concentration risk. Consider diversifying across different sectors and geographies.</p>
                            </div>
                        </div>
                    `,
                    related: ["assets", "allocation", "risk"]
                },

                returns: {
                    title: "Understanding Total Returns",
                    difficulty: "Intermediate",
                    category: "Performance",
                    content: `
                        <div class="space-y-4">
                            <p class="text-lg text-cyan-300">What is Total Return?</p>
                            <p>Total return measures your portfolio's overall performance from the first transaction to today. It includes both price appreciation and any dividends received.</p>

                            <div class="bg-gray-800/50 p-4 rounded">
                                <h4 class="font-bold text-gray-300 mb-3">Total Return Components:</h4>
                                <div class="space-y-3">
                                    <div class="flex justify-between items-center p-2 bg-green-900/20 rounded">
                                        <span><strong class="text-green-400">Capital Gains:</strong> Price appreciation of securities</span>
                                        <span class="text-green-400">+15.2%</span>
                                    </div>
                                    <div class="flex justify-between items-center p-2 bg-blue-900/20 rounded">
                                        <span><strong class="text-blue-400">Dividends:</strong> Income from holdings</span>
                                        <span class="text-blue-400">+2.8%</span>
                                    </div>
                                    <div class="flex justify-between items-center p-2 bg-cyan-900/20 rounded border-2 border-cyan-500">
                                        <span><strong class="text-cyan-400">Total Return:</strong> Combined performance</span>
                                        <span class="text-cyan-400 font-bold">+18.0%</span>
                                    </div>
                                </div>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="bg-green-900/20 p-4 rounded border-l-4 border-green-500">
                                    <h4 class="font-bold text-green-400 mb-2">Positive Returns:</h4>
                                    <ul class="text-sm space-y-1">
                                        <li>‚Ä¢ Portfolio value increased</li>
                                        <li>‚Ä¢ Investment goals achieved</li>
                                        <li>‚Ä¢ Wealth accumulation</li>
                                    </ul>
                                </div>
                                <div class="bg-red-900/20 p-4 rounded border-l-4 border-red-500">
                                    <h4 class="font-bold text-red-400 mb-2">Negative Returns:</h4>
                                    <ul class="text-sm space-y-1">
                                        <li>‚Ä¢ Portfolio value decreased</li>
                                        <li>‚Ä¢ Market timing challenges</li>
                                        <li>‚Ä¢ Learning opportunities</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    `,
                    related: ["cagr", "volatility", "sharpe"]
                },

                cagr: {
                    title: "Compound Annual Growth Rate (CAGR)",
                    difficulty: "Intermediate",
                    category: "Performance",
                    content: `
                        <div class="space-y-4">
                            <p class="text-lg text-cyan-300">What is CAGR?</p>
                            <p>CAGR measures the smoothed annual growth rate of your investment, assuming profits are reinvested. It's like the "average" annual return over time.</p>

                            <div class="bg-gray-800/50 p-4 rounded">
                                <h4 class="font-bold text-gray-300 mb-2">How CAGR Works:</h4>
                                <div class="text-sm space-y-2">
                                    <p><strong>Formula:</strong> (Ending Value √∑ Beginning Value)^(1 √∑ Years) - 1</p>
                                    <p><strong>Example:</strong> $10,000 growing to $15,000 in 5 years</p>
                                    <p><strong>CAGR:</strong> ($15,000 √∑ $10,000)^(1 √∑ 5) - 1 = 8.45%</p>
                                </div>
                            </div>

                            <div class="bg-blue-900/20 p-4 rounded border-l-4 border-blue-500">
                                <h4 class="font-bold text-blue-400 mb-2">üí° Why CAGR Matters:</h4>
                                <ul class="space-y-1">
                                    <li>‚Ä¢ Smooths out market volatility</li>
                                    <li>‚Ä¢ Allows fair comparisons</li>
                                    <li>‚Ä¢ Shows consistent growth rate</li>
                                    <li>‚Ä¢ Better than simple averages</li>
                                </ul>
                            </div>
                        </div>
                    `,
                    related: ["returns", "volatility", "sharpe"]
                },

                volatility: {
                    title: "Portfolio Volatility & Risk",
                    difficulty: "Intermediate",
                    category: "Risk Management",
                    content: `
                        <div class="space-y-4">
                            <p class="text-lg text-cyan-300">What is Volatility?</p>
                            <p>Volatility measures how much your portfolio's value fluctuates over time. Higher volatility means bigger price swings and more uncertainty.</p>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="bg-green-900/20 p-4 rounded border border-green-500/30">
                                    <h4 class="font-bold text-green-400 mb-2">Low Volatility (Stable):</h4>
                                    <ul class="text-sm space-y-1">
                                        <li>‚Ä¢ Steady, predictable returns</li>
                                        <li>‚Ä¢ Less stress and anxiety</li>
                                        <li>‚Ä¢ Good for conservative investors</li>
                                        <li>‚Ä¢ Often lower long-term returns</li>
                                    </ul>
                                </div>
                                <div class="bg-red-900/20 p-4 rounded border border-red-500/30">
                                    <h4 class="font-bold text-red-400 mb-2">High Volatility (Aggressive):</h4>
                                    <ul class="text-sm space-y-1">
                                        <li>‚Ä¢ Potential for higher returns</li>
                                        <li>‚Ä¢ More emotional stress</li>
                                        <li>‚Ä¢ Requires strong risk tolerance</li>
                                        <li>‚Ä¢ Higher chance of losses</li>
                                    </ul>
                                </div>
                            </div>

                            <div class="bg-yellow-900/20 p-4 rounded border-l-4 border-yellow-500">
                                <h4 class="font-bold text-yellow-400 mb-2">‚öñÔ∏è Risk-Return Balance:</h4>
                                <p>Generally, higher volatility comes with higher potential returns, but also higher potential losses. Your risk tolerance should match your investment goals and timeline.</p>
                            </div>
                        </div>
                    `,
                    related: ["sharpe", "var", "max_drawdown"]
                },

                sharpe: {
                    title: "Sharpe Ratio - Risk-Adjusted Returns",
                    difficulty: "Advanced",
                    category: "Risk Management",
                    content: `
                        <div class="space-y-4">
                            <p class="text-lg text-cyan-300">What is the Sharpe Ratio?</p>
                            <p>The Sharpe Ratio measures how much excess return you receive for the extra volatility you endure. It shows whether higher returns are worth the additional risk.</p>

                            <div class="bg-gray-800/50 p-4 rounded">
                                <h4 class="font-bold text-gray-300 mb-2">Sharpe Ratio Formula:</h4>
                                <div class="text-sm">
                                    <p><strong>(Portfolio Return - Risk-Free Rate) √∑ Portfolio Volatility</strong></p>
                                    <div class="mt-2 p-2 bg-cyan-900/20 rounded">
                                        <strong class="text-cyan-400">Good Sharpe Ratio:</strong> > 1.0 (efficient risk use)<br>
                                        <strong class="text-yellow-400">Average Sharpe Ratio:</strong> 0.5 - 1.0 (moderate)<br>
                                        <strong class="text-red-400">Poor Sharpe Ratio:</strong> < 0.5 (inefficient risk use)
                                    </div>
                                </div>
                            </div>

                            <div class="bg-green-900/20 p-4 rounded border-l-4 border-green-500">
                                <h4 class="font-bold text-green-400 mb-2">‚úÖ What Makes a Good Sharpe Ratio:</h4>
                                <ul class="space-y-1">
                                    <li>‚Ä¢ Higher ratio = Better risk-adjusted performance</li>
                                    <li>‚Ä¢ Above 1.0 generally considered good</li>
                                    <li>‚Ä¢ Compares favorably to market benchmarks</li>
                                    <li>‚Ä¢ Shows efficient use of risk</li>
                                </ul>
                            </div>
                        </div>
                    `,
                    related: ["volatility", "returns", "benchmark"]
                },

                allocation: {
                    title: "Asset Allocation Strategy",
                    difficulty: "Intermediate",
                    category: "Portfolio Management",
                    content: `
                        <div class="space-y-4">
                            <p class="text-lg text-cyan-300">What is Asset Allocation?</p>
                            <p>Asset allocation is how you divide your investment dollars across different types of assets (stocks, bonds, etc.) to balance risk and return.</p>

                            <div class="bg-gray-800/50 p-4 rounded">
                                <h4 class="font-bold text-gray-300 mb-2">Common Allocation Strategies:</h4>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-3 text-sm">
                                    <div class="p-3 bg-green-900/20 rounded">
                                        <strong class="text-green-400">Conservative:</strong><br>
                                        60% Bonds<br>
                                        40% Stocks<br>
                                        <em>Lower risk, lower returns</em>
                                    </div>
                                    <div class="p-3 bg-yellow-900/20 rounded">
                                        <strong class="text-yellow-400">Balanced:</strong><br>
                                        50% Bonds<br>
                                        50% Stocks<br>
                                        <em>Moderate risk/returns</em>
                                    </div>
                                    <div class="p-3 bg-red-900/20 rounded">
                                        <strong class="text-red-400">Aggressive:</strong><br>
                                        20% Bonds<br>
                                        80% Stocks<br>
                                        <em>Higher risk, higher returns</em>
                                    </div>
                                </div>
                            </div>

                            <div class="bg-blue-900/20 p-4 rounded border-l-4 border-blue-500">
                                <h4 class="font-bold text-blue-400 mb-2">üéØ Key Principles:</h4>
                                <ul class="space-y-1">
                                    <li>‚Ä¢ Match allocation to your risk tolerance</li>
                                    <li>‚Ä¢ Consider your investment timeline</li>
                                    <li>‚Ä¢ Rebalance periodically (annually)</li>
                                    <li>‚Ä¢ Diversify within each asset class</li>
                                </ul>
                            </div>
                        </div>
                    `,
                    related: ["diversification", "rebalancing", "risk"]
                },

                risk: {
                    title: "Understanding Investment Risk",
                    difficulty: "Beginner",
                    category: "Risk Management",
                    content: `
                        <div class="space-y-4">
                            <p class="text-lg text-cyan-300">What is Investment Risk?</p>
                            <p>Risk in investing refers to the possibility that your actual returns will differ from your expected returns. Not all risk is bad - some is necessary for growth.</p>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="bg-red-900/20 p-4 rounded border-l-4 border-red-500">
                                    <h4 class="font-bold text-red-400 mb-2">Market Risk (Systematic):</h4>
                                    <ul class="text-sm space-y-1">
                                        <li>‚Ä¢ Affects entire market</li>
                                        <li>‚Ä¢ Cannot be diversified away</li>
                                        <li>‚Ä¢ Economic factors, interest rates</li>
                                        <li>‚Ä¢ Requires broad diversification</li>
                                    </ul>
                                </div>
                                <div class="bg-orange-900/20 p-4 rounded border-l-4 border-orange-500">
                                    <h4 class="font-bold text-orange-400 mb-2">Company Risk (Unsystematic):</h4>
                                    <ul class="text-sm space-y-1">
                                        <li>‚Ä¢ Specific to individual companies</li>
                                        <li>‚Ä¢ Can be reduced through diversification</li>
                                        <li>‚Ä¢ Management changes, competition</li>
                                        <li>‚Ä¢ More manageable for investors</li>
                                    </ul>
                                </div>
                            </div>

                            <div class="bg-purple-900/20 p-4 rounded border-l-4 border-purple-500">
                                <h4 class="font-bold text-purple-400 mb-2">üõ°Ô∏è Risk Management Strategies:</h4>
                                <ul class="space-y-1">
                                    <li>‚Ä¢ Diversification across assets and sectors</li>
                                    <li>‚Ä¢ Regular portfolio rebalancing</li>
                                    <li>‚Ä¢ Appropriate asset allocation</li>
                                    <li>‚Ä¢ Understanding your risk tolerance</li>
                                    <li>‚Ä¢ Long-term investment horizon</li>
                                </ul>
                            </div>
                        </div>
                    `,
                    related: ["volatility", "diversification", "allocation"]
                },

                benchmark: {
                    title: "Benchmarking Your Performance",
                    difficulty: "Intermediate",
                    category: "Performance",
                    content: `
                        <div class="space-y-4">
                            <p class="text-lg text-cyan-300">What is Benchmarking?</p>
                            <p>Benchmarking compares your portfolio's performance against relevant market indices or similar investment strategies to understand how well you're doing.</p>

                            <div class="bg-gray-800/50 p-4 rounded">
                                <h4 class="font-bold text-gray-300 mb-2">Common Benchmarks:</h4>
                                <div class="space-y-2 text-sm">
                                    <div><strong class="text-cyan-400">S&P 500 (SPY):</strong> Large U.S. companies</div>
                                    <div><strong class="text-purple-400">Nasdaq 100 (QQQ):</strong> Tech-heavy index</div>
                                    <div><strong class="text-green-400">Total Stock Market (VTI):</strong> Entire U.S. market</div>
                                    <div><strong class="text-yellow-400">Bonds (BND):</strong> U.S. bond market</div>
                                </div>
                            </div>

                            <div class="bg-blue-900/20 p-4 rounded border-l-4 border-blue-500">
                                <h4 class="font-bold text-blue-400 mb-2">üìä Reading Benchmark Comparisons:</h4>
                                <ul class="space-y-1">
                                    <li><strong class="text-green-400">Above Benchmark:</strong> Outperforming the market</li>
                                    <li><strong class="text-gray-400">At Benchmark:</strong> Matching market performance</li>
                                    <li><strong class="text-red-400">Below Benchmark:</strong> Underperforming the market</li>
                                    <li>‚Ä¢ Consider fees, risk, and time horizon</li>
                                </ul>
                            </div>

                            <div class="bg-yellow-900/20 p-4 rounded border-l-4 border-yellow-500">
                                <h4 class="font-bold text-yellow-400 mb-2">‚ö†Ô∏è Important Note:</h4>
                                <p>Not all benchmarks are appropriate for all portfolios. Choose benchmarks that match your investment style and risk level.</p>
                            </div>
                        </div>
                    `,
                    related: ["returns", "sharpe", "tracking_error"]
                },

                allocation_detail: {
                    title: "Detailed Allocation Analysis",
                    difficulty: "Advanced",
                    category: "Portfolio Management",
                    content: `
                        <div class="space-y-4">
                            <p class="text-lg text-cyan-300">Deep Dive: Asset Allocation</p>
                            <p>This interactive view allows you to explore individual holdings and their contribution to your portfolio's performance and risk.</p>

                            <div class="bg-gray-800/50 p-4 rounded">
                                <h4 class="font-bold text-gray-300 mb-2">What You Can Learn Here:</h4>
                                <ul class="space-y-2 text-sm">
                                    <li>‚Ä¢ Individual stock performance contribution</li>
                                    <li>‚Ä¢ Sector and industry exposure</li>
                                    <li>‚Ä¢ Risk concentration in specific positions</li>
                                    <li>‚Ä¢ Potential impact of removing/reducing positions</li>
                                </ul>
                            </div>

                            <div class="bg-green-900/20 p-4 rounded border-l-4 border-green-500">
                                <h4 class="font-bold text-green-400 mb-2">üí° Pro Tips:</h4>
                                <ul class="space-y-1">
                                    <li>‚Ä¢ Click any segment in the allocation chart</li>
                                    <li>‚Ä¢ Review concentration risk regularly</li>
                                    <li>‚Ä¢ Consider tax implications of changes</li>
                                    <li>‚Ä¢ Balance individual conviction with diversification</li>
                                </ul>
                            </div>
                        </div>
                    `,
                    related: ["allocation", "concentration", "rebalancing"]
                }
            };

            const info = educationalContent[topic] || {
                title: "Financial Education",
                content: "<p>Select a metric to learn more about it.</p>",
                difficulty: "General",
                category: "Education"
            };

            // Update modal content (using existing variables from function scope)
            // Note: modalTitle, difficultyBadge, etc. are already declared at function start

            modalTitle.textContent = info.title;
            content.innerHTML = info.content;

            // Update badges
            if (difficultyBadge && categoryBadge) {
                difficultyBadge.textContent = info.difficulty || "General";
                difficultyBadge.className = `px-2 py-1 rounded text-xs font-bold ${
                    info.difficulty === 'Beginner' ? 'bg-green-900/50 text-green-400' :
                    info.difficulty === 'Intermediate' ? 'bg-yellow-900/50 text-yellow-400' :
                    info.difficulty === 'Advanced' ? 'bg-red-900/50 text-red-400' :
                    'bg-gray-800 text-gray-400'
                }`;

                categoryBadge.textContent = info.category || "General";
                categoryBadge.className = `px-2 py-1 rounded text-xs font-bold bg-blue-900/50 text-blue-400`;
            }

            // Handle extra data for specific topics
            if (topic === 'allocation_detail' && extraData) {
                content.innerHTML += `
                    <div class="mt-4 p-4 bg-cyan-900/20 rounded border border-cyan-500/30">
                        <h4 class="font-bold text-cyan-400 mb-2">Selected Holding Details:</h4>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div><strong>Ticker:</strong> ${extraData.ticker}</div>
                            <div><strong>Weight:</strong> ${extraData.percentage}</div>
                            <div><strong>Value:</strong> $${extraData.value}</div>
                            <div><strong>Impact:</strong> ${extraData.percentage > 10 ? 'High' : extraData.percentage > 5 ? 'Medium' : 'Low'}</div>
                        </div>
                    </div>
                `;
            }

            // Show related topics
            if (relatedContainer && info.related && info.related.length > 0) {
                const relatedHtml = info.related.map(relatedTopic => {
                    const relatedInfo = educationalContent[relatedTopic];
                    return relatedInfo ? `<button class="text-cyan-400 hover:text-cyan-300 underline" onclick="showEducationalModal('${relatedTopic}')">${relatedInfo.title}</button>` : '';
                }).filter(Boolean).join(' ‚Ä¢ ');

                relatedContainer.innerHTML = `
                    <div class="text-sm text-gray-400">
                        <strong>Related Topics:</strong> ${relatedHtml}
                    </div>
                `;
            } else if (relatedContainer) {
                relatedContainer.innerHTML = '';
            }

            // Navigation buttons (for future implementation)
            if (prevBtn && nextBtn) {
                prevBtn.classList.add('hidden');
                nextBtn.classList.add('hidden');
            }

            modal.style.display = 'flex';
            modal.focus();
        }

        // Show help modal
        function showHelpModal() {
            showEducationalModal('help');
        }

        // Close modal
        function closeModal() {
            const modal = document.getElementById('education-modal');
            if (modal) {
                modal.style.setProperty('display', 'none', 'important');
                modal.setAttribute('aria-hidden', 'true');
            }
        }

        // Update connection status
        function updateConnectionStatus() {
            const statusElement = document.getElementById('connection-status');
            // Status is already shown as connected when data loads successfully
        }

        // Show status messages
        function showStatusMessage(message, type = 'info') {
            const container = document.getElementById('status-messages');

            const messageDiv = document.createElement('div');
            messageDiv.className = `p-4 rounded mb-4 ${
                type === 'success' ? 'bg-green-900/50 text-green-400 border border-green-500/50' :
                type === 'error' ? 'bg-red-900/50 text-red-400 border border-red-500/50' :
                'bg-cyan-900/50 text-cyan-400 border border-cyan-500/50'
            }`;
            messageDiv.innerHTML = `
                <div class="flex items-center">
                    <span class="mr-2">${
                        type === 'success' ? '‚úì' :
                        type === 'error' ? '‚úó' :
                        '‚Ñπ'
                    }</span>
                    <span>${message}</span>
                </div>
            `;

            container.appendChild(messageDiv);

            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.remove();
                }
            }, 5000);
        }

        // Export data function
        function exportData() {
            showStatusMessage('Data export feature coming soon!', 'info');
        }

        // Create custom portfolio function
        function createCustomPortfolio() {
            window.location.href = '/comparison';
        }

        // Helper function to calculate moving average
        function calculateMovingAverage(data, period) {
            const result = [];
            for (let i = period - 1; i < data.length; i++) {
                const sum = data.slice(i - period + 1, i + 1).reduce((a, b) => a + b, 0);
                result.push(sum / period);
            }
            return result;
        }

        // Onboarding System
        let currentOnboardingStep = 0;
        const onboardingSteps = [
            {
                title: "Welcome to Portfolio Analysis",
                content: `
                    <div class="text-center space-y-4">
                        <div class="text-6xl mb-4">üöÄ</div>
                        <p class="text-lg">Welcome to your cyberpunk portfolio analysis dashboard!</p>
                        <p>This tool transforms your Robinhood data into powerful financial insights.</p>
                        <div class="bg-cyan-900/20 p-4 rounded border border-cyan-500/30 mt-6">
                            <h4 class="font-bold text-cyan-400 mb-2">What You'll Learn:</h4>
                            <ul class="text-left space-y-1 text-sm">
                                <li>‚Ä¢ Understand your investment performance</li>
                                <li>‚Ä¢ Analyze risk and diversification</li>
                                <li>‚Ä¢ Compare portfolios and strategies</li>
                                <li>‚Ä¢ Make data-driven investment decisions</li>
                            </ul>
                        </div>
                    </div>
                `
            },
            {
                title: "Upload Your Data",
                content: `
                    <div class="space-y-4">
                        <div class="text-center mb-6">
                            <div class="text-4xl mb-2">üì§</div>
                            <p class="text-lg">First, let's get your data uploaded</p>
                        </div>
                        <div class="bg-gray-800/50 p-4 rounded">
                            <h4 class="font-bold text-gray-300 mb-2">How to Get Your Data:</h4>
                            <ol class="text-sm space-y-2 text-left">
                                <li><strong>1.</strong> Log into Robinhood on the web</li>
                                <li><strong>2.</strong> Go to Account ‚Üí Documents ‚Üí Tax Documents</li>
                                <li><strong>3.</strong> Generate and download your transaction history</li>
                                <li><strong>4.</strong> Return here and upload the CSV file</li>
                            </ol>
                        </div>
                        <div class="bg-green-900/20 p-4 rounded border border-green-500/30">
                            <p class="text-green-400 text-sm">
                                <strong>Privacy First:</strong> Your data is processed securely and never stored permanently.
                            </p>
                        </div>
                    </div>
                `
            },
            {
                title: "Understanding Key Metrics",
                content: `
                    <div class="space-y-4">
                        <div class="text-center mb-6">
                            <div class="text-4xl mb-2">üìä</div>
                            <p class="text-lg">Key metrics explained</p>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="bg-cyan-900/20 p-4 rounded border border-cyan-500/30">
                                <h4 class="font-bold text-cyan-400 mb-2">Total Return</h4>
                                <p class="text-sm">Your overall portfolio performance since the first transaction.</p>
                                <button class="text-cyan-400 hover:text-cyan-300 text-sm underline mt-2" onclick="closeOnboardingModal(); showEducationalModal('returns')">
                                    Learn more ‚Üí
                                </button>
                            </div>
                            <div class="bg-purple-900/20 p-4 rounded border border-purple-500/30">
                                <h4 class="font-bold text-purple-400 mb-2">Volatility</h4>
                                <p class="text-sm">How much your portfolio value fluctuates over time.</p>
                                <button class="text-purple-400 hover:text-purple-300 text-sm underline mt-2" onclick="closeOnboardingModal(); showEducationalModal('volatility')">
                                    Learn more ‚Üí
                                </button>
                            </div>
                        </div>
                        <div class="bg-yellow-900/20 p-4 rounded border border-yellow-500/30">
                            <p class="text-yellow-400 text-sm text-center">
                                üí° <strong>Pro Tip:</strong> Click "Learn more" on any metric to get detailed explanations!
                            </p>
                        </div>
                    </div>
                `
            },
            {
                title: "Explore Advanced Features",
                content: `
                    <div class="space-y-4">
                        <div class="text-center mb-6">
                            <div class="text-4xl mb-2">üî¨</div>
                            <p class="text-lg">Deep dive into your portfolio</p>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="text-center p-4 bg-gray-800/50 rounded">
                                <div class="text-2xl mb-2">üìà</div>
                                <h4 class="font-bold mb-1">Analysis</h4>
                                <p class="text-xs text-gray-400">Detailed performance breakdowns</p>
                            </div>
                            <div class="text-center p-4 bg-gray-800/50 rounded">
                                <div class="text-2xl mb-2">‚öñÔ∏è</div>
                                <h4 class="font-bold mb-1">Compare</h4>
                                <p class="text-xs text-gray-400">Portfolio comparison tools</p>
                            </div>
                            <div class="text-center p-4 bg-gray-800/50 rounded">
                                <div class="text-2xl mb-2">üéØ</div>
                                <h4 class="font-bold mb-1">Scenarios</h4>
                                <p class="text-xs text-gray-400">What-if analysis</p>
                            </div>
                        </div>
                        <div class="bg-blue-900/20 p-4 rounded border border-blue-500/30">
                            <p class="text-blue-400 text-sm">
                                <strong>Navigation:</strong> Use the tabs at the top to explore different analysis views.
                            </p>
                        </div>
                    </div>
                `
            },
            {
                title: "You're All Set!",
                content: `
                    <div class="text-center space-y-6">
                        <div class="text-6xl mb-4">üéâ</div>
                        <h3 class="text-2xl font-bold glow-text">Ready to Analyze!</h3>
                        <p class="text-lg">You've completed the onboarding tour. Here's how to get started:</p>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-8">
                            <div class="text-left">
                                <h4 class="font-bold text-green-400 mb-3">üöÄ Quick Start:</h4>
                                <ul class="text-sm space-y-2">
                                    <li>‚Ä¢ Upload your Robinhood CSV</li>
                                    <li>‚Ä¢ Explore the dashboard metrics</li>
                                    <li>‚Ä¢ Click "Learn more" on any metric</li>
                                    <li>‚Ä¢ Try the Analysis and Compare tabs</li>
                                </ul>
                            </div>
                            <div class="text-left">
                                <h4 class="font-bold text-cyan-400 mb-3">üí° Pro Tips:</h4>
                                <ul class="text-sm space-y-2">
                                    <li>‚Ä¢ Hover over charts for details</li>
                                    <li>‚Ä¢ Use keyboard shortcuts (Ctrl+R)</li>
                                    <li>‚Ä¢ Check related topics in help modals</li>
                                    <li>‚Ä¢ Compare different scenarios</li>
                                </ul>
                            </div>
                        </div>

                        <div class="bg-gradient-to-r from-pink-500/20 via-cyan-500/20 to-purple-500/20 p-6 rounded border border-cyan-500/30 mt-8">
                            <p class="text-lg font-bold text-cyan-400 mb-2">Remember:</p>
                            <p class="text-gray-300">Investing involves risk. This tool helps you understand your portfolio better, but past performance doesn't guarantee future results.</p>
                        </div>
                    </div>
                `
            }
        ];

        // Check if user has seen onboarding
        function checkOnboardingStatus() {
            try {
                // Use a unique, consistent key for persistence
                const ONBOARDING_KEY = 'robinhood_dashboard_welcome_dismissed';
                const hasSeenOnboarding = localStorage.getItem(ONBOARDING_KEY);
                console.log('[ONBOARDING] Has seen onboarding:', hasSeenOnboarding, 'Key:', ONBOARDING_KEY);
                
                // Only show onboarding if user hasn't seen it
                if (hasSeenOnboarding === 'true') {
                    console.log('[ONBOARDING] User has already completed onboarding, skipping');
                    return;
                }
                
                // Show onboarding for new users
                setTimeout(() => showOnboardingModal(), 1000);
            } catch (e) {
                console.error('[ONBOARDING] Error checking status:', e);
            }
        }

        // Show onboarding modal
        function showOnboardingModal() {
            currentOnboardingStep = 0;
            updateOnboardingContent();
            const modal = document.getElementById('onboarding-modal');
            if (modal) {
                modal.style.display = 'flex';
                modal.focus();
            }
        }

        // Update onboarding content
        function updateOnboardingContent() {
            const content = document.getElementById('onboarding-content');
            const title = document.getElementById('onboarding-title');
            const stepIndicator = document.getElementById('step-indicator');
            const progressBar = document.getElementById('onboarding-progress');
            const prevBtn = document.getElementById('prev-step-btn');
            const nextBtn = document.getElementById('next-step-btn');

            const step = onboardingSteps[currentOnboardingStep];
            title.textContent = step.title;
            content.innerHTML = step.content;

            stepIndicator.textContent = `Step ${currentOnboardingStep + 1} of ${onboardingSteps.length}`;
            progressBar.style.width = `${((currentOnboardingStep + 1) / onboardingSteps.length) * 100}%`;

            // Update navigation buttons
            prevBtn.disabled = currentOnboardingStep === 0;
            nextBtn.textContent = currentOnboardingStep === onboardingSteps.length - 1 ? 'Get Started!' : 'Next';

            // Update skip button visibility
            const skipBtn = document.getElementById('skip-onboarding-btn');
            skipBtn.style.display = currentOnboardingStep === onboardingSteps.length - 1 ? 'none' : 'inline-block';
        }

        // Navigate onboarding steps
        function nextOnboardingStep() {
            if (currentOnboardingStep < onboardingSteps.length - 1) {
                currentOnboardingStep++;
                updateOnboardingContent();
            } else {
                completeOnboarding();
            }
        }

        function prevOnboardingStep() {
            if (currentOnboardingStep > 0) {
                currentOnboardingStep--;
                updateOnboardingContent();
            }
        }

        // Complete onboarding
        function completeOnboarding() {
            const ONBOARDING_KEY = 'robinhood_dashboard_welcome_dismissed';
            localStorage.setItem(ONBOARDING_KEY, 'true');
            console.log('[ONBOARDING] Marked as completed with key:', ONBOARDING_KEY);
            const modal = document.getElementById('onboarding-modal');
            if (modal) {
                modal.style.setProperty('display', 'none', 'important');
                modal.setAttribute('aria-hidden', 'true');
            }
            showStatusMessage('Welcome! Upload your data to get started.', 'success');
        }

        // Skip onboarding
        function skipOnboarding() {
            try {
                const ONBOARDING_KEY = 'robinhood_dashboard_welcome_dismissed';
                localStorage.setItem(ONBOARDING_KEY, 'true');
                console.log('[ONBOARDING] Skipped and marked with key:', ONBOARDING_KEY);
                const modal = document.getElementById('onboarding-modal');
                if (modal) {
                    modal.style.setProperty('display', 'none', 'important');
                    modal.setAttribute('aria-hidden', 'true');
                    console.log('[ONBOARDING] Modal closed');
                } else {
                    console.warn('[ONBOARDING] Onboarding modal not found');
                }
            } catch (error) {
                console.error('[ONBOARDING] Error skipping onboarding:', error);
            }
        }

        // Close onboarding modal (alias for skip)
        function closeOnboardingModal() {
            skipOnboarding();
        }

        // Add onboarding event listeners
        document.addEventListener('DOMContentLoaded', function() {
            const nextBtn = document.getElementById('next-step-btn');
            const prevBtn = document.getElementById('prev-step-btn');

            if (nextBtn) nextBtn.addEventListener('click', nextOnboardingStep);
            if (prevBtn) prevBtn.addEventListener('click', prevOnboardingStep);

            // Check onboarding status after a delay
            setTimeout(checkOnboardingStatus, 2000);
        });

        // Global functions for HTML onclick handlers
        window.showEducationalModal = showEducationalModal;
        window.closeModal = closeModal;
        window.closeOnboardingModal = closeOnboardingModal;
        window.skipOnboarding = skipOnboarding;
        window.exportData = exportData;
        window.createCustomPortfolio = createCustomPortfolio;
    </script>
</body>
</html>
